<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SimpList - Simple To-Do List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      min-height: 100vh;
    }
    .topbar {
      display: flex;
      align-items: center;
      background: #2196F3;
      color: white;
      padding: 0 16px;
      height: 40px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      gap: 8px;
    }
    .topbar .icon-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 26px;
      margin-right: 10px;
      padding: 4px;
      border-radius: 50%;
      transition: background 0.15s;
    }
    .topbar .icon-btn:hover { background: rgba(255,255,255,0.15);}
    .topbar .spacer { flex: 1; }
    .container {
      padding: 24px 10px;
      max-width: 95%;
      margin: 0 auto;
    }
    .card-list {
	  width: 100%;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card-mat {
	  width: 100%;
      background: #fff;
      border-radius: 3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      padding-bottom: 8px;
      overflow: hidden;
      position: relative;
      transition: box-shadow 0.2s;
    }
    .card-mat.dragging {
      opacity: 0.6;
      box-shadow: 0 8px 24px rgba(0,0,0,0.22);
    }
    .card-header {
	  width: 100%;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ededed;
      background: #f3edff;
      padding: 1px 1px 1px 0px;
      gap: 8px;
      transition: background 0.3s;
      position: relative;
    }
    .collapse-btn {
      font-size: 30px;
      background: none;
      color: #000000;
      border: none;
      cursor: pointer;
      margin-right: 2px;
      transition: transform 0.2s;
    }
    .collapse-btn.collapsed {
      transform: rotate(-90deg);
      color: #000000;
    }
    .card-title {
      font-weight: 500;
      font-size: 1.12em;
      border: none;
      background: transparent;
      border-radius: 3px;
      padding: 3px 6px;
      outline: none;
      margin-right: 8px;
      flex: 1 1 0;
    }
    .card-title[readonly] {
      background: transparent;
      color: #222;
      cursor: pointer;
    }
    .card-header .icon-btn {
      font-size: 30px;
      color: #000000;
      margin: 0 1px;
      padding: 2px;
      border-radius: 50%;
      background: none;
      border: none;
      cursor: pointer;
    }
    .card-header .icon-btn:hover { color: #1976D2; }
    .color-btn {
      background: none;
      border: 3px;
      cursor: pointer;
      padding: 0;
      margin: 0 4px 0 0;
    }
    .color-btn input[type="color"] {
      width: 24px;
      height: 24px;
      border: 3px;
      background: none;
      padding: -10px;
      cursor: pointer;
      vertical-align: middle;
    }
    .card-content { padding: 0 12px; }
    .task-list {
	  width: 100%;
      list-style: none;
      padding: 0;
      margin: 0 0 8px 0;
    }
    .task-list li {
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 32px;
      padding: 2px 0;
      user-select: none;
      background: transparent;
      transition: background 0.13s;
      position: relative;
    }
    .task-list li.dragging {
      background: #e0e0fa;
      opacity: 0.6;
    }
    .task-list input[type="checkbox"] {
      margin-right: 5px;
      width: 18px;
      height: 18px;
      accent-color: #2962FF;
      cursor: pointer;
    }
    .task-list label, .subtask-list label {
      flex: 1;
      cursor: pointer;
      padding: 2px 3px;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .task-list label.task-done, .subtask-list label.task-done {
      text-decoration: line-through;
      color: #888;
    }
    .task-list .icon-btn, .subtask-list .icon-btn {
      font-size: 20px;
      color: #000000;
      margin: 0 1px;
      padding: 2px;
      border-radius: 50%;
      background: none;
      border: none;
      cursor: pointer;
    }
    .task-list .icon-btn:hover, .subtask-list .icon-btn:hover {
      color: #1976D2;
    }
	
.task-list label.editing {
  margin-right: auto;
}

.task-list label.task-done {
  margin-right: 100%;
}


    .add-task-row, .add-subtask-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      margin-top: 6px;
      align-items: center;
    }
    .add-task-row input, .add-subtask-row input {
      flex: 1 1 auto;
      padding: 7px 8px;
      border: 1px solid #bdbdbd;
      border-radius: 3px;
      font-size: 1em;
      outline: none;
      background: #fafafa;
    }
    .add-task-row input:focus, .add-subtask-row input:focus {
      border-color: #1976D2;
      background: #fff;
    }
    .add-task-row .icon-btn, .add-subtask-row .icon-btn {
      font-size: 22px;
      color: #00C853;
      padding: 4px;
    }
    .collapsed .card-content { display: none; }

    /* Modal styles */
    .modal-overlay {
      background: rgba(30, 0, 70, 0.18);
      position: fixed;
      z-index: 50;
      left: 0; right: 0; top: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 3px;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.19);
      padding: 22px 18px 16px 18px;
      min-width: 320px;
      max-width: 96vw;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      margin-top: 0;
      margin-bottom: 14px;
      font-size: 1.16em;
      color: #333;
      font-weight: 500;
    }
    .modal .close-btn {
      border: none;
      background: none;
      color: #1976D2;
      font-size: 1.8em;
      position: absolute;
      top: 11px; right: 20px;
      cursor: pointer;
      z-index: 2;
    }
    .modal .notes-label {
      font-size: 0.98em;
      color: #666;
      margin-bottom: 2px;
      margin-top: 11px;
      display: block;
    }
    .modal textarea {
      width: 100%;
      font-family: inherit;
      font-size: 1em;
      padding: 10px;
      border-radius: 3px;
      border: 1px solid #bbb;
      min-height: 90px;
      background: #f7f6fa;
      resize: vertical;
      margin-bottom: 10px;
      box-sizing: border-box;
      transition: border 0.2s;
    }
    .modal textarea:focus {
      outline: 2px solid #1976D2;
      border-color: #1976D2;
      background: #fff;
    }
    .subtask-list {
      list-style: none;
      padding: 0;
      margin: 0 0 8px 0;
    }
    .subtask-list li {
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 32px;
      padding: 2px 0;
      user-select: none;
    }
    .subtask-list input[type="checkbox"] {
      margin-right: 5px;
      width: 16px;
      height: 16px;
      accent-color: #2962FF;
      cursor: pointer;
    }
    .subtask-list .icon-btn {
      background: none;
      border: none;
      color: #757575;
      font-size: 18px;
      border-radius: 3px;
      cursor: pointer;
      margin: 0 1px;
      padding: 2px;
    }
    .subtask-list .icon-btn:hover {
      color: #1976D2;
    }
    .edit-input {
      font-size: inherit;
      border: 1px solid #bdbdbd;
      border-radius: 3px;
      padding: 2px 5px;
      margin-left: -4px;
      min-width: 70px;
    }
    .drag-handle {
      cursor: grab;
      font-size: 19px;
      opacity: 0.7;
      margin-right: 2px;
      transition: opacity 0.2s;
      user-select: none;
    }
    .drag-handle:active {
      opacity: 1;
      cursor: grabbing;
    }
    .drag-over {
      box-shadow: 0 0 0 3px #6a82fb;
      background: #e0e0fa !important;
    }
    .due-highlight {
      background: #FFFF8D !important;
      border-radius: 3px;
      transition: background 0.2s;
    }
    .overdue-highlight {
      background: #FF8A80 !important;
      border-radius: 3px;
      transition: background 0.2s;
    }
    .due-date-input {
      width: 120px;
      font-size: 0.98em;
      padding: 2px 4px;
      border: 1px solid #bdbdbd;
      border-radius: 3px;
      background: #fafafa;
      margin-left: 5px;
      margin-right: 3px;
    }
    .due-date-input:focus {
      border-color: #1976D2;
      background: #fff;
    }
    @media (max-width: 95%) {
      .container { padding: 8px 2px; }
      .topbar { height: 48px; }
      .modal { min-width: 90vw; }
      .due-date-input { width: 45px; }
    }
	
.due-date-label {
      margin-right: 0px;
      font-weight: 500;
      font-size: 0.9em;
	  vertical-align: top;
}

.icon-btn {
  color: #000000;
  background: none;
  border: none;
  cursor: pointer;
}

.icon-btn:hover {
  color: #1976D2;
  background: none;
  border: none;
  cursor: pointer;
}


  </style>
</head>
<body>
  <div class="topbar">
    <button class="icon-btn" id="add-card-btn" title="Add Folder"><span class="material-symbols-outlined">
add
</span></button>
    <button class="icon-btn" id="download-btn" title="Download data"><span class="material-symbols-outlined">
download
</span></button>
    <button class="icon-btn" id="upload-btn" title="Upload data"><span class="material-symbols-outlined">
upload
</span></button>
    <input id="file-upload-input" type="file" accept="application/json" style="display:none">
    <span class="spacer"></span>
    <span style="font-size:1.2em;">SimpList</span>
  </div>
  <div class="container">
    <div class="card-list" id="card-list"></div>
  </div>
  <div id="modal-root"></div>

<script>
  // --- Data helpers
  const STORAGE_KEY = 'simplist-data';
  function uid() {
    return Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  }
  function saveData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function loadData() {
    try {
      const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (!Array.isArray(d)) throw new Error();
      return d;
    } catch { return []; }
  }
  function normalizeCards(cards) {
    for (const card of cards) {
      card.tasks = card.tasks || [];
      for (const t of card.tasks) {
        if (typeof t.due !== "string") t.due = "";
        t.subtasks = t.subtasks || [];
        for (const st of t.subtasks) {
          if (typeof st.due !== "string") st.due = "";
        }
      }
    }
  }
  let cards = loadData();
  normalizeCards(cards);

  // --- Modal helpers
  function showModal(title, contentFn, onClose) {
    const root = document.getElementById('modal-root');
    root.innerHTML = '';
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.tabIndex = -1;

    const modal = document.createElement('div');
    modal.className = 'modal';
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = close;
    modal.appendChild(closeBtn);

    if (title) {
      const h3 = document.createElement('h3');
      h3.textContent = title;
      modal.appendChild(h3);
    }

    contentFn(modal, close);

    overlay.appendChild(modal);
    root.appendChild(overlay);

    setTimeout(() => { overlay.focus(); }, 70);

    function close() {
      root.innerHTML = '';
      if (onClose) onClose();
    }
    overlay.onclick = (e) => { if (e.target === overlay) close(); };
    document.addEventListener('keydown', escHandler);
    function escHandler(e) { if (e.key === 'Escape') close(); }
    overlay.cleanup = () => document.removeEventListener('keydown', escHandler);
  }

  const cardList = document.getElementById('card-list');

  function parseLocalDate(dateStr) {
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return null;
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    return isNaN(date.getTime()) ? null : date;
  }
  function isDueToday(dateStr) {
    const due = parseLocalDate(dateStr);
    if (!due) return false;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    due.setHours(0, 0, 0, 0);
    return due.getTime() === today.getTime();
  }
  function isOverdue(dateStr) {
    const due = parseLocalDate(dateStr);
    if (!due) return false;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    due.setHours(0, 0, 0, 0);
    return due.getTime() < today.getTime();
  }

function renderCards() {
  const cardList = document.querySelector('.card-list');



  // --- Clear and Re-render Cards ---
  cardList.innerHTML = '';
  cards.forEach((card, i) => {
    cardList.appendChild(renderCard(card, i));
  });
}




    // Robust local date parsing for YYYY-MM-DD
function parseLocalDate(dateStr) {
  if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return null;
  const [year, month, day] = dateStr.split('-').map(Number);
  const date = new Date(year, month - 1, day);
  return isNaN(date.getTime()) ? null : date;
}
function isDueToday(dateStr) {
  const due = parseLocalDate(dateStr);
  if (!due) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  due.setHours(0, 0, 0, 0);
  return due.getTime() === today.getTime();
}

    function isOverdue(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      const due = parseLocalDate(dateStr);
      return due && due.getTime() < today.getTime();
    }

    function renderCard(card, cardIdx) {
      const wrap = document.createElement('div');
      wrap.className = 'card-mat' + (card.collapsed ? ' collapsed' : '');
	  
	  // Make the card draggable

wrap.ondragstart = (e) => {
  wrap.classList.add('dragging');
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData('text/plain', cardIdx); // Store the card index
};

wrap.ondragend = () => {
  wrap.classList.remove('dragging');
};
wrap.ondragover = (e) => {
  e.preventDefault();
  wrap.classList.add('drag-over');
};

wrap.ondragleave = () => {
  wrap.classList.remove('drag-over');
};

wrap.ondrop = (e) => {
  e.preventDefault();
  wrap.classList.remove('drag-over');

  const fromIdx = parseInt(e.dataTransfer.getData('text/plain'), 10);
  const toIdx = cardIdx; // This is the index of the card you're dropping onto

  if (fromIdx !== toIdx && fromIdx >= 0 && toIdx >= 0) {
    const [moved] = cards.splice(fromIdx, 1);
    cards.splice(toIdx, 0, moved);
    saveData(cards);
    renderCards();
  }
};
      // --- Card Header ---
      const header = document.createElement('div');
      header.className = 'card-header';

      // Custom color
      const colorVal = card.headerColor || "#E3F2FD";
      header.style.background = colorVal;

      // Color picker
      const colorBtn = document.createElement('button');
      colorBtn.className = 'color-btn';
      colorBtn.title = 'Change card header color';
      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = colorVal;
      colorInput.addEventListener("mousedown", e => e.stopPropagation());
      colorInput.addEventListener("click", e => e.stopPropagation());
      colorBtn.addEventListener("mousedown", e => e.stopPropagation());
      colorBtn.addEventListener("click", e => e.stopPropagation());
      colorInput.addEventListener("input", (e) => {
        card.headerColor = e.target.value;
        header.style.background = card.headerColor;
        saveData(cards);
      });
      colorBtn.appendChild(colorInput);
      header.appendChild(colorBtn);

      // Drag handle
      const dragHandle = document.createElement('span');
      dragHandle.className = 'drag-handle';
      dragHandle.title = 'Drag to reorder cards';
      dragHandle.innerHTML = '<span class="material-symbols-outlined">drag_handle</span>';
      header.appendChild(dragHandle);

dragHandle.draggable = true;

dragHandle.ondragstart = (e) => {
  wrap.classList.add('dragging');
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData('text/plain', cardIdx); // Store the card index
};

dragHandle.ondragend = () => {
  wrap.classList.remove('dragging');
};

header.appendChild(dragHandle);

      // Collapse btn
      const collapse = document.createElement('button');
      collapse.className = 'icon-btn collapse-btn' + (card.collapsed ? ' collapsed' : '');
      collapse.title = card.collapsed ? 'Expand' : 'Collapse';
      collapse.innerHTML = '<span class="material-symbols-outlined">arrow_downward</span>';
      collapse.onclick = () => { card.collapsed = !card.collapsed; saveData(cards); renderCards(); };
      header.appendChild(collapse);

      // Title (single click to edit)
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.value = card.title || '';
      titleInput.className = 'card-title';
      titleInput.setAttribute('readonly', 'readonly');
      titleInput.onclick = () => {
        titleInput.removeAttribute('readonly');
        titleInput.focus();
        titleInput.select();
      };
      titleInput.onblur = () => {
        titleInput.setAttribute('readonly', 'readonly');
        card.title = titleInput.value.trim();
        saveData(cards);
      };
      titleInput.onkeydown = (e) => {
        if (e.key === 'Enter') { titleInput.blur(); }
      };
      header.appendChild(titleInput);

      // Copy
      const copyBtn = document.createElement('button');
      copyBtn.className = 'icon-btn';
      copyBtn.title = 'Copy folder';
      copyBtn.innerHTML = '<span class="material-symbols-outlined">folder_copy</span>';
      copyBtn.onclick = () => {
        const newCard = JSON.parse(JSON.stringify(card));
        newCard.id = uid();
        newCard.title = card.title + ' (Copy)';
        cards.push(newCard);
        saveData(cards);
        renderCards();
      };
      header.appendChild(copyBtn);

      // Delete
      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = 'Delete folder';
      delBtn.innerHTML = '<span class="material-symbols-outlined">delete</span>';
      delBtn.onclick = () => {
        if (confirm('Delete this folder?')) {
          cards = cards.filter(c => c.id !== card.id);
          saveData(cards);
          renderCards();
        }
      };
      header.appendChild(delBtn);

      wrap.appendChild(header);

      // --- Card Content ---
      const content = document.createElement('div');
      content.className = 'card-content';
      if (card.collapsed) content.style.display = 'none';

// --- Tasks ---
const ul = document.createElement('ul');
ul.className = 'task-list';
card.tasks = card.tasks || [];

// Render each task
card.tasks.forEach((task, i) => {
  const taskEl = renderTask(card, i);
  ul.appendChild(taskEl);
});

// --- Drag & Drop Tasks ---
setTimeout(() => {
  const lis = Array.from(ul.children);

  lis.forEach((li) => {
    li.draggable = true;

    li.ondragstart = (e) => {
      li.classList.add('dragging');
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData('text/plain', Array.from(ul.children).indexOf(li));
    };

    li.ondragend = () => {
      li.classList.remove('dragging');
      lis.forEach(l => l.classList.remove('drag-over'));
    };

    li.ondragover = (e) => {
      e.preventDefault();
      li.classList.add('drag-over');
    };

    li.ondragleave = () => {
      li.classList.remove('drag-over');
    };

    li.ondrop = (e) => {
      e.preventDefault();
      lis.forEach(l => l.classList.remove('drag-over'));

      const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
      const to = Array.from(ul.children).indexOf(li); // Live index of drop target

      if (from !== to && from >= 0 && to >= 0) {
        const [moved] = card.tasks.splice(from, 1);
        card.tasks.splice(to, 0, moved);
        saveData(cards);
        renderCards();
      }
    };

    // Prevent drag from starting on inputs/buttons
    li.addEventListener('mousedown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
        e.stopPropagation();
      }
    });
  });
}, 1);

content.appendChild(ul);

      // Add task row
      const addRow = document.createElement('div');
      addRow.className = 'add-task-row';
      const tf = document.createElement('input');
      tf.type = 'text';
      tf.placeholder = 'Add task';
      tf.onkeydown = (e) => {
        if (e.key === 'Enter' && tf.value.trim()) {
          card.tasks.push({text: tf.value.trim(), done: false, subtasks: [], notes: '', due: ""});
          tf.value = '';
          saveData(cards);
          renderCards();
        }
      };
      addRow.appendChild(tf);
      const addBtn = document.createElement('button');
      addBtn.className = 'icon-btn';
      addBtn.title = 'Add task';
      addBtn.innerHTML = '<span class="material-symbols-outlined">add_box</span>';
      addBtn.onclick = () => {
        if (tf.value.trim()) {
          card.tasks.push({text: tf.value.trim(), done: false, subtasks: [], notes: '', due: ""});
          tf.value = '';
          saveData(cards);
          renderCards();
        }
      };
      addRow.appendChild(addBtn);
      content.appendChild(addRow);

      wrap.appendChild(content);
      return wrap;
    }

    function renderTask(card, idx) {
      const task = card.tasks[idx];
      const li = document.createElement('li');
	  const hasIncompleteSubtasks = task.subtasks && task.subtasks.some(st => !st.done);
const hasSubtasks = task.subtasks && task.subtasks.length > 0;



      // Highlight due date
      if (isOverdue(task.due)) {
        li.classList.add("overdue-highlight");
      } else if (isDueToday(task.due)) {
        li.classList.add("due-highlight");
      }

      // Drag handle
      const dragHandle = document.createElement('span');
      dragHandle.className = 'drag-handle';
      dragHandle.title = 'Drag to reorder tasks';
      dragHandle.innerHTML = '<span class="material-symbols-outlined">drag_handle</span>';
      li.appendChild(dragHandle);

      // Checkbox

const cb = document.createElement('input');
cb.type = 'checkbox';
cb.checked = !!task.done;

// Disable checkbox if there are incomplete subtasks
if (hasSubtasks && hasIncompleteSubtasks) {
  cb.disabled = true;
  cb.title = 'Complete all subtasks to mark this task done';
}

cb.onchange = () => {
  task.done = cb.checked;
  saveData(cards);
  renderCards();
};
li.appendChild(cb);

      
	  // Subtask indicator icon
	  if (hasSubtasks) {
  const subtaskIcon = document.createElement('span');
  subtaskIcon.className = 'material-symbols-outlined subtask-indicator';
  subtaskIcon.textContent = hasIncompleteSubtasks ? 'assignment' : 'assignment_turned_in';
  subtaskIcon.title = hasIncompleteSubtasks ? 'Incomplete subtasks' : 'All subtasks complete';
  subtaskIcon.style.color = hasIncompleteSubtasks ? '#D50000' : '#4caf50'
  subtaskIcon.style.fontSize = '24px';
  li.appendChild(subtaskIcon);
}


  // --- Editable Label or Input ---
  if (task._edit) {
    const editWrapper = document.createElement('div');
    editWrapper.style.display = 'flex';
    editWrapper.style.alignItems = 'left';
    editWrapper.style.gap = '1px';
    editWrapper.style.width = '100%';

    const inp = document.createElement('input');
    inp.type = 'text';
    inp.value = task.text;
    inp.className = 'edit-input';
    inp.style.flex = '1';
    inp.style.marginRight = 'auto';

    inp.onkeydown = (e) => {
      if (e.key === 'Enter') finishEdit();
    };
    inp.onblur = finishEdit;

    setTimeout(() => inp.focus(), 50);

    function finishEdit() {
      task.text = inp.value.trim();
      delete task._edit;
      saveData(cards);
      renderCards();
    }

    editWrapper.appendChild(inp);
    li.appendChild(editWrapper);
  } else {
    const lbl = document.createElement('label');
    lbl.textContent = task.text;
    lbl.className = task.done ? 'task-done' : '';
    lbl.onclick = () => {
      for (const t of card.tasks) delete t._edit;
      task._edit = true;
      renderCards();
    };
    li.appendChild(lbl);
  }

// Due date

const dueLabel = document.createElement('span');
dueLabel.className = 'due-date-label';
dueLabel.innerHTML = 'Due Date:';

const dueInput = document.createElement('input');
dueInput.type = 'date';
dueInput.className = 'due-date-input';
dueInput.value = task.due || "";
dueInput.title = "Due date";
dueInput.onchange = (e) => {
  task.due = dueInput.value || "";
  saveData(cards);
  renderCards();
};

li.appendChild(dueLabel);
li.appendChild(dueInput);

      // Notes/subtasks
      const modalBtn = document.createElement('button');
      modalBtn.className = 'icon-btn';
      modalBtn.title = 'Subtasks & Notes';
      modalBtn.innerHTML = '<span class="material-symbols-outlined">checklist</span>';
      modalBtn.onclick = (e) => {
        e.stopPropagation();
        showTaskModal(card, task);
      };
      li.appendChild(modalBtn);

      // Copy Task
      const copyTaskBtn = document.createElement('button');
      copyTaskBtn.className = 'icon-btn';
      copyTaskBtn.title = 'Copy task';
      copyTaskBtn.innerHTML = '<span class="material-symbols-outlined">content_copy</span>';
      copyTaskBtn.onclick = () => {
        const newTask = JSON.parse(JSON.stringify(task));
        newTask.text = task.text + ' (Copy)';
        card.tasks.push(newTask);
        saveData(cards);
        renderCards();
      };
      li.appendChild(copyTaskBtn);

      // Delete
      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = 'Delete task';
      delBtn.innerHTML = '<span class="material-symbols-outlined">delete</span>';
      delBtn.onclick = () => {
        card.tasks.splice(idx, 1);
        saveData(cards);
        renderCards();
      };
      li.appendChild(delBtn);

      return li;
    }

    function renderSubtask(task, idx) {
      const sub = task.subtasks[idx];
      const li = document.createElement('li');
      if (isOverdue(sub.due)) {
        li.classList.add("overdue-highlight");
      } else if (isDueToday(sub.due)) {
        li.classList.add("due-highlight");
      }
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!sub.done;
      cb.onchange = () => {
        sub.done = cb.checked;
        saveData(cards);
        renderSubtaskDialog(task);
      };
      li.appendChild(cb);

      if (sub._edit) {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = sub.text;
        inp.className = 'edit-input';
        inp.maxLength = 100;
        inp.onkeydown = (e) => { if (e.key === 'Enter') finishEdit(); };
        inp.onblur = finishEdit;
        setTimeout(() => inp.focus(), 50);
        li.appendChild(inp);
        function finishEdit() {
          sub.text = inp.value.trim();
          delete sub._edit;
          saveData(cards);
          renderSubtaskDialog(task);
        }
      } else {
        const lbl = document.createElement('label');
        lbl.textContent = sub.text;
        lbl.className = sub.done ? 'task-done' : '';
        lbl.onclick = () => {
          for (const s of task.subtasks) delete s._edit;
          sub._edit = true;
          renderSubtaskDialog(task);
        };
        li.appendChild(lbl);
      }

      // Due date for subtask
      const dueInput = document.createElement('input');
      dueInput.type = 'date';
      dueInput.className = 'due-date-input';
      dueInput.value = sub.due || "";
      dueInput.title = "Due date";
      dueInput.onchange = (e) => {
        sub.due = dueInput.value || "";
        saveData(cards);
        renderSubtaskDialog(task);
      };
      li.appendChild(dueInput);
      if (sub.due) {
        const dueLabel = document.createElement('span');
        dueLabel.className = 'due-date-label';
        dueLabel.textContent = sub.due;
        li.appendChild(dueLabel);
      }

      // Delete
      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = 'Delete subtask';
      delBtn.innerHTML = '<span class="material-symbols-outlined">delete</span>';
      delBtn.onclick = () => {
        task.subtasks.splice(idx, 1);
        saveData(cards);
        renderSubtaskDialog(task);
      };
      li.appendChild(delBtn);
      return li;
    }

    function showTaskModal(card, task) {
      showModal('Subtasks & Notes', (modal, close) => {
        // Subtasks
        const subUl = document.createElement('ul');
        subUl.className = 'subtask-list';
        for (let i=0; i<task.subtasks.length; ++i) {
          subUl.appendChild(renderSubtask(task,i));
        }
        modal.appendChild(subUl);

        // Add subtask row
        const addSubRow = document.createElement('div');
        addSubRow.className = 'add-subtask-row';
        const subTf = document.createElement('input');
        subTf.type = 'text';
        subTf.placeholder = 'Add subtask';
        subTf.maxLength = 100;
        subTf.onkeydown = (e) => {
          if (e.key === 'Enter' && subTf.value.trim()) {
            task.subtasks.push({text: subTf.value.trim(), done: false, due: ""});
            subTf.value = '';
            saveData(cards);
            renderSubtaskDialog(task);
          }
        };
        addSubRow.appendChild(subTf);
        const addSubBtn = document.createElement('button');
        addSubBtn.className = 'icon-btn';
        addSubBtn.title = 'Add subtask';
        addSubBtn.innerHTML = '<span class="material-symbols-outlined">add_box</span>';
        addSubBtn.onclick = () => {
          if (subTf.value.trim()) {
            task.subtasks.push({text: subTf.value.trim(), done: false, due: ""});
            subTf.value = '';
            saveData(cards);
            renderSubtaskDialog(task);
          }
        };
        addSubRow.appendChild(addSubBtn);
        modal.appendChild(addSubRow);

        // Notes
        const notesLabel = document.createElement('label');
        notesLabel.className = 'notes-label';
        notesLabel.textContent = 'Notes:';
        modal.appendChild(notesLabel);
        const notesArea = document.createElement('textarea');
        notesArea.id = 'modal-notes-textarea';
        notesArea.rows = 10;
        notesArea.value = task.notes || '';
        notesArea.placeholder = "Notes...";
        notesArea.oninput = () => {
          task.notes = notesArea.value;
          saveData(cards);
        };
        modal.appendChild(notesArea);

        function renderSubtaskDialog(task) {
          subUl.innerHTML = '';
          for (let i=0; i<task.subtasks.length; ++i) {
            subUl.appendChild(renderSubtask(task,i));
          }
        }
      });
    }

    document.getElementById('add-card-btn').onclick = () => {
      showModal('Create New Folder', (modal, close) => {
        const tf = document.createElement('input');
        tf.type = 'text';
        tf.placeholder = 'Folder title';
        tf.maxLength = 60;
        tf.autofocus = true;
        tf.style.fontSize = "1.07em";
        tf.style.padding = "7px 8px";
        tf.style.width = "90%";
        tf.style.marginBottom = "5px";
        modal.appendChild(tf);
        tf.focus();
        tf.onkeydown = (e) => {
          if (e.key === 'Enter' && tf.value.trim()) {
            cards.push({id: uid(), title: tf.value.trim(), tasks: [], collapsed: false});
            saveData(cards);
            renderCards();
            close();
          }
        };
      });
    };

    document.getElementById('download-btn').onclick = () => {
      const blob = new Blob([JSON.stringify(cards, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'simplist-data.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    };
    document.getElementById('upload-btn').onclick = () => {
      document.getElementById('file-upload-input').click();
    };
    document.getElementById('file-upload-input').addEventListener('change', function(e) {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const data = JSON.parse(ev.target.result);
          if (!Array.isArray(data)) throw new Error();
          cards = data.map(card => ({
            id: card.id || uid(),
            title: card.title || '',
            tasks: Array.isArray(card.tasks) ? card.tasks.map(t => ({
              text: t.text || '',
              done: !!t.done,
              subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(st => ({
                text: st.text || '',
                done: !!st.done,
                due: typeof st.due === "string" ? st.due : "",
              })) : [],
              notes: typeof t.notes === "string" ? t.notes : "",
              due: typeof t.due === "string" ? t.due : ""
            })) : [],
            collapsed: !!card.collapsed,
            headerColor: card.headerColor || "#f3edff"
          }));
          normalizeCards(cards);
          saveData(cards);
          renderCards();
        } catch {
          alert('Could not load data: Invalid file format.');
        }
      };
      reader.readAsText(file);
      this.value = '';
    });

    renderCards();
  </script>
</body>
</html>