<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simplist</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <style>
    /* --- Simplist Base Styles (COMPACT MODE) --- */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      min-height: 100vh;
      font-size: 13px;
    }
    .topbar {
      display: flex;
      align-items: center;
      background: #2196F3;
      color: white;
      padding: 0 12px;
      height: 40px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      gap: 8px;
    }
    .topbar h1 { font-size: 1.1rem; margin: 0; font-weight: 500; }
    .topbar .spacer { flex: 1; }
    .topbar .icon-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 20px;
      padding: 6px;
      border-radius: 50%;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .topbar .icon-btn:hover { background: rgba(255,255,255,0.15); }

    .container {
      padding: 15px 10px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* --- Custom Button / Clipboard Manager Styles --- */
    #custom-buttons-section {
      margin-top: 30px; 
      border-top: 1px solid #ddd; 
      padding-top: 15px;
      animation: fadeIn 0.4s ease;
    }
    
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    .search-input {
      flex: 1;
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 13px;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
      border-color: #2196f3;
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    /* FOLDERS & LISTS COMMON STYLES */
    .folder-div, .card-mat {
      background: #fff;
      border-radius: 6px;
      margin-bottom: 8px;
      overflow: visible; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    .folder-div.dragging, .card-mat.dragging {
      opacity: 0.4;
      border: 2px dashed #2196f3;
    }
    .folder-div.drag-over, .buttons-list.drag-over {
        background-color: #e3f2fd;
        border: 2px dashed #2196f3;
    }

    .folder-header, .card-header {
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
      transition: filter 0.2s;
      border-radius: 5px 5px 0 0;
    }
    
    .folder-div.collapsed .folder-header,
    .card-mat.collapsed .card-header {
      border-radius: 5px;
    }

    .folder-header:hover, .card-header:hover { filter: brightness(1.05); }
    .folder-header .title-area, .card-header .title-area { display: flex; align-items: center; gap: 6px; flex: 1; }
    
    .controls button {
      background: rgba(255,255,255,0.3);
      border: none;
      color: inherit;
      margin-left: 4px;
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .controls button:hover { background: rgba(255,255,255,0.5); }
    
    .buttons-list, .card-content {
      padding: 8px;
      background: #fff;
      border-radius: 0 0 5px 5px;
    }
    
    .folder-div.collapsed .buttons-list,
    .card-mat.collapsed .card-content {
      display: none;
    }
    
    .buttons-list {
       display: flex;
       flex-wrap: wrap;
       gap: 6px;
       background: #f9f9f9; 
       min-height: 30px; 
    }

    .progress-track {
      height: 3px;
      background: rgba(0,0,0,0.1);
      border-radius: 2px;
      margin-top: 4px;
      width: 100%;
      overflow: hidden;
      display: none; 
    }
    .progress-fill {
      height: 100%;
      background: rgba(255,255,255,0.8);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .copy-box {
      position: relative;
      padding: 5px 10px;
      border-radius: 15px;
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 12px;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transition: transform 0.1s, box-shadow 0.15s, filter 0.15s;
      display: flex;
      align-items: center;
      user-select: none;
    }
    .copy-box:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      filter: brightness(1.05);
      z-index: 1000;
    }
    .copy-box:active { transform: scale(0.96); }
    .copy-box.dragging { opacity: 0.5; border: 2px dashed #333; }

    .tooltip {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 6px 10px;
      position: absolute;
      z-index: 9999;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      width: max-content;
      max-width: 250px;
      font-size: 11px;
      font-weight: normal;
      pointer-events: none;
      white-space: pre-wrap;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      line-height: 1.3;
    }
    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    .copy-box:hover .tooltip { visibility: visible; opacity: 1; }

    /* --- Simplist Task Styles --- */
    .card-list { 
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
    }
    .task-list { list-style: none; padding: 0; margin: 0; min-height: 15px; }
    
    .task-node { 
        border-bottom: 1px solid #f0f0f0; 
        padding: 4px 0;
        border: 2px solid transparent; 
        border-radius: 4px;
        transition: border-color 0.1s, background-color 0.1s;
    }
    .task-node.dragging-task { opacity: 0.4; }
    .task-node.drop-above { border-top: 2px solid #2196f3; }
    .task-node.drop-below { border-bottom: 2px solid #2196f3; }
    .task-node.drop-inside { background-color: #e8f5e9; border: 2px dashed #4caf50; }
    
    .task-children { margin-left: 20px; border-left: 1px solid #eee; padding-left: 6px; }
    .task-children.hidden { display: none; }
    .task-row { display: flex; align-items: center; gap: 6px; padding: 2px 0; }
    
    /* STATUS ICONS */
    .task-status-icon { 
        cursor: pointer; 
        user-select: none; 
        font-size: 18px; 
        width: 18px; height: 18px;
        transition: color 0.2s, transform 0.1s;
    }
    .task-status-icon:active { transform: scale(0.9); }
    .status-todo { color: #bdbdbd; }
    .status-doing { color: #fb8c00; }
    .status-done { color: #4caf50; }

    .task-text { flex: 1; margin: 0; outline: none; font-size: 13px; line-height: 1.4; padding: 2px 4px; border-radius: 4px; border: 1px solid transparent; cursor: text; }
    .task-text:focus { background: #fff; border-color:#ddd; }
    .task-done { text-decoration: line-through; color: #888; }
    
    .date-input { border: 1px solid #ddd; border-radius: 4px; padding: 2px; font-size: 10px; color: #666; font-family: inherit; background: #f9f9f9; cursor: pointer; max-width: 90px; }
    .date-input:hover { background: #eee; }
    .date-input.overdue { border-color: #e57373; color: #d32f2f; background: #ffebee; }
    .date-input.upcoming { border-color: #ffb74d; color: #e65100; background: #fff3e0; }
    
    .node-progress-track { height: 3px; background: #eee; border-radius: 2px; margin-top: 2px; margin-left: 24px; overflow: hidden; width: 80px; display: inline-block; vertical-align: middle; margin-right: 8px; }
    .node-progress-fill { height: 100%; background: #4caf50; transition: width 0.3s; }
    
    .action-btn { color: #ccc; cursor: pointer; font-size: 16px; user-select: none; }
    .action-btn:hover { color: #2196f3; }
    .action-btn.delete:hover { color: #e57373; }
    .action-btn.has-note { color: #2196f3; }
    
    /* RICH TEXT EDITOR */
    .task-note-block {
        margin-left: 44px;
        margin-right: 10px;
        margin-top: 4px;
        margin-bottom: 8px;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 4px;
        animation: fadeIn 0.2s;
    }
    .rte-toolbar {
        display: flex;
        background: #f0f0f0;
        border-bottom: 1px solid #ddd;
        padding: 2px;
        border-radius: 4px 4px 0 0;
        gap: 2px;
    }
    .rte-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: bold;
        color: #555;
        border-radius: 2px;
    }
    .rte-btn:hover { background: #e0e0e0; color: #000; }
    .rte-editor {
        width: 100%;
        min-height: 40px;
        padding: 8px;
        font-family: inherit;
        font-size: 12px;
        outline: none;
        color: #333;
        box-sizing: border-box;
        line-height: 1.4;
    }
    .rte-editor ul { padding-left: 20px; margin: 4px 0; }
    .rte-editor:focus { background: #fff; }

    .collapse-icon { cursor: pointer; font-size: 18px; color: #999; user-select: none; width: 18px; display: inline-flex; justify-content: center; }
    .collapse-icon:hover { color: #555; }
    .collapse-placeholder { width: 18px; }
    
    .add-task-row { display: flex; gap: 8px; margin-top: 10px; }
    .add-task-input { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; outline: none; font-size: 13px; }
    .add-task-input:focus { border-color: #2196f3; }
    .template-picker-btn { background: #e3f2fd; color: #2196f3; border: none; border-radius: 4px; cursor: pointer; padding: 0 8px; display: flex; align-items: center; justify-content: center; }
    .template-picker-btn:hover { background: #bbdefb; }
    
    /* Drag Handle Styles */
    .drag-handle { cursor: grab; margin-right: 4px; color: rgba(0,0,0,0.2); font-size: 18px; user-select: none; }
    .drag-handle:hover { color: rgba(0,0,0,0.4); }
    .drag-handle:active { cursor: grabbing; }
    .card-drag-handle { cursor: grab; } 
    .task-drag-handle { cursor: grab; color: #ddd; font-size: 16px; margin-right: 2px; user-select: none; }
    .task-drag-handle:hover { color: #999; }
    .task-drag-handle:active { cursor: grabbing; color: #2196f3; }

    /* --- Modals (Compact) --- */
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 10000; }
    .modal { background: white; padding: 20px; border-radius: 8px; width: 500px; max-width: 95%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 90vh; display: flex; flex-direction: column; }
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; margin-bottom: 4px; font-weight: 500; color: #555; font-size: 12px; }
    .input-group input[type="text"], .input-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: 13px; }
    .input-group input[type="color"] { width: 100%; height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
    .modal-actions-right { display: flex; gap: 8px; margin-left: auto; }
    .btn-primary { background: #2196f3; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 13px; }
    .btn-secondary { background: #ddd; color: #333; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .btn-danger { background: #e57373; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .tags-list-container { max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 12px; padding: 4px; border-radius: 4px; }
    .tag-item { display: flex; justify-content: space-between; align-items: center; padding: 6px; background: #f9f9f9; margin-bottom: 4px; border-radius: 4px; font-size: 13px; }
    .tag-item:last-child { margin-bottom: 0; }
    .tag-key { font-weight: bold; color: #2196f3; margin-right: 10px; }
    .tag-actions { display:flex; gap: 4px; }
    .mini-menu { position: absolute; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-radius: 4px; padding: 4px 0; z-index: 5000; width: 180px; max-height: 250px; overflow-y: auto; display: none; right: 0; bottom: 100%; }
    .mini-menu-item { padding: 6px 12px; cursor: pointer; font-size: 13px; color: #333; }
    .mini-menu-item:hover { background: #f0f0f0; color: #2196f3; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="topbar">
  <span class="material-symbols-outlined" style="font-size: 22px;">checklist</span>
  <h1>Simplist</h1>
  <div class="spacer"></div>
  <button class="icon-btn" onclick="exportData()" title="Export Data"><span class="material-symbols-outlined">download</span></button>
  <button class="icon-btn" onclick="document.getElementById('file-upload').click()" title="Import Data"><span class="material-symbols-outlined">upload</span></button>
  <input type="file" id="file-upload" style="display:none" accept=".json,.html,.txt">
</div>

<div class="container">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; margin-top:15px;">
    <h2 style="margin:0; font-size:1.2rem; color:#444;">Task Lists</h2>
    <div style="display:flex; gap:8px;">
        <button class="btn-secondary" onclick="openTemplateManager()">
            <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle;">extension</span> Templates
        </button>
        <button class="btn-primary" onclick="openListModal(null)">+ New List</button>
    </div>
  </div>
  
  <div class="search-row">
      <input type="text" id="task-search" class="search-input" placeholder="Search tasks..." onkeyup="renderCards()">
  </div>
  
  <div class="card-list" id="card-list"></div>

  <div id="custom-buttons-section">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <h2 style="margin:0; font-size:1.2rem; color:#444;">Quick Copy Buttons</h2>
      <div style="display:flex; gap:8px;">
        <button class="btn-secondary" onclick="openTagsModal()">
          <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle;">sell</span> Manage Tags
        </button>
        <button class="btn-primary" onclick="openFolderModal(null)">+ New Folder</button>
      </div>
    </div>
    <div class="search-row">
      <input type="text" id="button-search" class="search-input" placeholder="Search buttons..." onkeyup="renderButtonFolders()">
    </div>
    <div id="folders-container"></div>
  </div>
</div>

<div id="folder-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="folder-modal-title" style="margin-top:0; font-size:1.2rem;">Folder Settings</h3>
    <div class="input-group"><label>Folder Name</label><input type="text" id="folder-name-input"></div>
    <div class="input-group"><label>Folder Color</label><input type="color" id="folder-color-input" value="#2196f3"></div>
    <div class="modal-actions">
       <button id="folder-delete-btn" class="btn-danger" style="display:none;" onclick="deleteFolderHelper()">Delete</button>
       <div class="modal-actions-right"><button class="btn-secondary" onclick="closeFolderModal()">Cancel</button><button class="btn-primary" onclick="saveFolder()">Save</button></div>
    </div>
  </div>
</div>

<div id="list-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="list-modal-title" style="margin-top:0; font-size:1.2rem;">List Settings</h3>
    <div class="input-group"><label>List Name</label><input type="text" id="list-name-input"></div>
    <div class="input-group"><label>List Header Color</label><input type="color" id="list-color-input" value="#673ab7"></div>
    <div class="modal-actions">
       <button id="list-delete-btn" class="btn-danger" style="display:none;" onclick="deleteListHelper()">Delete</button>
       <div class="modal-actions-right"><button class="btn-secondary" onclick="closeListModal()">Cancel</button><button class="btn-primary" onclick="saveList()">Save</button></div>
    </div>
  </div>
</div>

<div id="btn-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="btn-modal-title" style="margin-top:0; font-size:1.2rem;">Add Copy Button</h3>
    <div class="input-group"><label>Button Label</label><input type="text" id="btn-label-input"></div>
    <div class="input-group">
      <label>Message Content</label><textarea id="btn-content-input" rows="4"></textarea>
      <div style="display:flex; justify-content:space-between; margin-top:4px;">
        <small style="color:#666;">Supports [Date], [Time], Tags</small>
        <select id="tag-inserter" style="font-size:11px; padding:2px;" onchange="insertTagIntoMessage(this)"><option value="">+ Insert Tag</option></select>
      </div>
    </div>
    <div class="input-group"><label>Button Color</label><input type="color" id="btn-color-input" value="#2196f3"></div>
    <div class="modal-actions">
      <button id="btn-delete-btn" class="btn-danger" style="display:none;" onclick="deleteButtonHelper()">Delete</button>
      <div class="modal-actions-right"><button class="btn-secondary" onclick="closeBtnModal()">Cancel</button><button class="btn-primary" onclick="saveButton()">Save</button></div>
    </div>
  </div>
</div>

<div id="tags-modal" class="modal-overlay">
    <div class="modal">
      <h3 style="margin-top:0; font-size:1.2rem;">Manage Custom Tags</h3>
      <div id="tags-list" class="tags-list-container"></div>
      <div style="border-top:1px solid #eee; padding-top:12px;">
          <h4 id="tag-form-title" style="margin:0 0 8px 0; font-size:13px;">Add New Tag</h4>
          <div style="display:flex; gap:8px; margin-bottom:8px;"><input type="text" id="new-tag-key" placeholder="Tag" style="flex:1;"><input type="text" id="new-tag-val" placeholder="Value" style="flex:1;"></div>
          <div style="display:flex; gap:5px;"><button id="tag-cancel-btn" class="btn-secondary" style="display:none; flex:1;" onclick="cancelEditTag()">Cancel</button><button id="tag-save-btn" class="btn-primary" style="flex:1;" onclick="saveCustomTag()">Add Tag</button></div>
      </div>
      <div class="modal-actions"><button class="btn-secondary" onclick="closeTagsModal()">Close</button></div>
    </div>
</div>

<div id="template-modal" class="modal-overlay">
    <div class="modal">
        <h3 style="margin-top:0; font-size:1.2rem;">Task Templates</h3>
        <div id="tpl-list-view">
            <div id="tpl-list" class="tags-list-container" style="min-height:150px;"></div>
            <button class="btn-primary" style="width:100%; margin-top:8px;" onclick="showTemplateEditor(null)">+ Create New Template</button>
        </div>
        <div id="tpl-editor-view" style="display:none;">
            <div class="input-group"><label>Template Name</label><input type="text" id="tpl-name-input"></div>
            <label style="display:block; margin-bottom:4px; font-weight:500; color:#555; font-size:12px;">Template Structure</label>
            <div id="tpl-tree-container" class="tags-list-container" style="max-height:220px; background:#fafafa; border:1px solid #ddd;"></div>
            <button class="btn-secondary" style="width:100%; margin-top:5px; font-size:12px;" onclick="addRootTemplateItem()">+ Add Step</button>
            <div class="modal-actions"><button class="btn-secondary" onclick="showTemplateList()">Back</button><button class="btn-primary" onclick="saveTemplate()">Save Template</button></div>
        </div>
        <div class="modal-actions" id="tpl-main-actions"><button class="btn-secondary" onclick="closeTemplateManager()">Close</button></div>
    </div>
</div>

<script>
// --- UTILITIES ---
function getContrastYIQ(hexcolor){
    if(!hexcolor) return 'white';
    if(hexcolor.length === 4) hexcolor='#'+hexcolor[1]+hexcolor[1]+hexcolor[2]+hexcolor[2]+hexcolor[3]+hexcolor[3];
    var r=parseInt(hexcolor.substr(1,2),16),g=parseInt(hexcolor.substr(3,2),16),b=parseInt(hexcolor.substr(5,2),16);
    return ((r*299)+(g*587)+(b*114))/1000 >= 128 ? '#212121':'white';
}
function escapeHtml(text){ if(!text)return ''; return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
function escapeRegExp(string){ return string.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function replaceTags(text){
  const now=new Date();
  let res=text.replace(/\[Date\]/gi, now.toLocaleDateString()).replace(/\[Time\]/gi, now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
  customTags.forEach(t=>{ res=res.replace(new RegExp(escapeRegExp(t.name),'gi'), t.value); });
  return res;
}
function getDateStatus(dateStr){
    if(!dateStr) return '';
    const today=new Date(); today.setHours(0,0,0,0);
    const due=new Date(dateStr+"T00:00:00");
    const diffDays=Math.ceil((due-today)/(1000*60*60*24));
    if(diffDays<0) return 'overdue';
    if(diffDays>=0 && diffDays<=7) return 'upcoming';
    return '';
}
function formatRichText(cmd, value=null) { document.execCommand(cmd, false, value); }

// --- DATA ---
let buttonFolders = JSON.parse(localStorage.getItem('foldersV2')) || [];
if(Array.isArray(buttonFolders)) buttonFolders.forEach(f=>{if(f.collapsed===undefined)f.collapsed=false;});
let customTags = JSON.parse(localStorage.getItem('customTags')) || [{name:'[MyName]',value:'Your Name'}];
let cards = JSON.parse(localStorage.getItem('simpList-data')) || [{id:'1',title:'To Do',color:'#673ab7',tasks:[{text:'Welcome to Simplist!',status:'todo',due:'',note:'',subtasks:[]}]}];
if(Array.isArray(cards)) cards.forEach(c=>{if(c.collapsed===undefined)c.collapsed=false;});
let taskTemplates = JSON.parse(localStorage.getItem('simpList-templates')) || [];
let currentTemplateTree=[];

// --- STATE ---
let editingFolderId=null, editingBtnIndex=null, targetFolderId=null, editingTagIndex=null, editingListId=null, editingTemplateId=null;
let dragSrcIndex=null, dragType=null, dragSrcFolderIndex=null, dragSrcButtonIndex=null, dragSrcTaskPath=null, dragSrcCardIndex=null;

// --- TAGS ---
function openTagsModal(){ renderTagsList(); cancelEditTag(); document.getElementById('tags-modal').style.display='flex'; }
function closeTagsModal(){ document.getElementById('tags-modal').style.display='none'; }
function renderTagsList(){
    const list=document.getElementById('tags-list'); list.innerHTML='';
    if(customTags.length===0){ list.innerHTML='<div style="text-align:center;padding:10px;color:#999;">No custom tags.</div>'; return; }
    customTags.forEach((t,i)=>{
        const item=document.createElement('div'); item.className='tag-item';
        if(i===editingTagIndex){ item.style.border="1px solid #2196f3"; item.style.background="#e3f2fd"; }
        item.innerHTML=`<div><span class="tag-key">${escapeHtml(t.name)}</span> &rarr; ${escapeHtml(t.value)}</div><div class="tag-actions"><button onclick="editCustomTag(${i})" style="border:none;background:none;color:#FFA000;cursor:pointer;">‚úé</button><button onclick="deleteCustomTag(${i})" style="border:none;background:none;color:#e57373;cursor:pointer;">‚úï</button></div>`;
        list.appendChild(item);
    });
}
function editCustomTag(i){ editingTagIndex=i; document.getElementById('new-tag-key').value=customTags[i].name; document.getElementById('new-tag-val').value=customTags[i].value; document.getElementById('tag-form-title').innerText="Edit Tag"; document.getElementById('tag-save-btn').innerText="Update"; document.getElementById('tag-cancel-btn').style.display="inline-block"; renderTagsList(); }
function cancelEditTag(){ editingTagIndex=null; document.getElementById('new-tag-key').value=''; document.getElementById('new-tag-val').value=''; document.getElementById('tag-form-title').innerText="Add New Tag"; document.getElementById('tag-save-btn').innerText="Add"; document.getElementById('tag-cancel-btn').style.display="none"; renderTagsList(); }
function saveCustomTag(){
    const k=document.getElementById('new-tag-key').value.trim(), v=document.getElementById('new-tag-val').value.trim();
    if(!k||!v)return alert("Tag and Value required.");
    if(editingTagIndex!==null) customTags[editingTagIndex]={name:k,value:v}; else customTags.push({name:k,value:v});
    localStorage.setItem('customTags',JSON.stringify(customTags)); cancelEditTag();
}
function deleteCustomTag(i){ if(confirm("Delete tag?")){ if(editingTagIndex===i)cancelEditTag(); customTags.splice(i,1); localStorage.setItem('customTags',JSON.stringify(customTags)); renderTagsList(); }}

// --- TEMPLATES ---
function openTemplateManager(){ showTemplateList(); document.getElementById('template-modal').style.display='flex'; }
function closeTemplateManager(){ document.getElementById('template-modal').style.display='none'; }
function showTemplateList(){
    document.getElementById('tpl-list-view').style.display='block'; document.getElementById('tpl-editor-view').style.display='none'; document.getElementById('tpl-main-actions').style.display='flex';
    const list=document.getElementById('tpl-list'); list.innerHTML='';
    if(taskTemplates.length===0){ list.innerHTML='<div style="padding:15px;text-align:center;color:#888;">No templates.</div>'; return; }
    taskTemplates.forEach(t=>{
        const div=document.createElement('div'); div.className='tag-item';
        div.innerHTML=`<div><strong>${escapeHtml(t.name)}</strong></div><div class="tag-actions"><button onclick="showTemplateEditor('${t.id}')" style="border:none;background:none;color:#2196f3;cursor:pointer;">‚úé</button><button onclick="deleteTemplate('${t.id}')" style="border:none;background:none;color:#e57373;cursor:pointer;">‚úï</button></div>`;
        list.appendChild(div);
    });
}
function cloneTree(t){ return t.map(n=>({text:n.text, note:n.note||'', subtasks:n.subtasks?cloneTree(n.subtasks):[]})); }
function showTemplateEditor(id){
    editingTemplateId=id; document.getElementById('tpl-list-view').style.display='none'; document.getElementById('tpl-editor-view').style.display='block'; document.getElementById('tpl-main-actions').style.display='none';
    if(id){ const t=taskTemplates.find(x=>x.id===id); document.getElementById('tpl-name-input').value=t.name; currentTemplateTree=cloneTree(t.subtasks||[]); }
    else{ document.getElementById('tpl-name-input').value=''; currentTemplateTree=[{text:"New Step",note:"",subtasks:[]}]; }
    renderTemplateTree();
}
function getTemplateNode(path){ let n={subtasks:currentTemplateTree}; for(let i of path) n=n.subtasks[i]; return n; }
function renderTemplateTree(){
    const c=document.getElementById('tpl-tree-container'); c.innerHTML='';
    function build(nodes, path){
        const ul=document.createElement('div'); ul.style.paddingLeft=path.length>0?'20px':'0';
        nodes.forEach((n,i)=>{
            const cur=[...path,i]; const div=document.createElement('div'); div.style.marginBottom="8px"; div.style.borderLeft="2px solid #eee"; div.style.paddingLeft="8px";
            div.innerHTML=`<div style="display:flex;gap:5px;margin-bottom:4px;"><input type="text" value="${escapeHtml(n.text)}" onchange="updateTemplateNodeText('${cur.join(',')}',this.value)" style="flex:1;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:13px;"><button onclick="toggleTemplateNote('${cur.join(',')}')" title="Note" style="border:none;background:none;color:${n.note?'#2196f3':'#ccc'};cursor:pointer;">üìù</button><button onclick="addTemplateSubNode('${cur.join(',')}')" style="border:none;background:#e3f2fd;color:#2196f3;border-radius:3px;">+</button><button onclick="deleteTemplateNode('${cur.join(',')}')" style="border:none;background:#ffebee;color:#e57373;border-radius:3px;">&times;</button></div>`;
            
            // Rich Text Note Block for Template
            if(n.noteOpen) {
                const noteDiv = document.createElement('div'); noteDiv.className = 'task-note-block';
                noteDiv.innerHTML = `
                    <div class="rte-toolbar">
                        <button class="rte-btn" onmousedown="event.preventDefault();formatRichText('bold')">B</button>
                        <button class="rte-btn" onmousedown="event.preventDefault();formatRichText('italic')">I</button>
                        <button class="rte-btn" onmousedown="event.preventDefault();formatRichText('insertUnorderedList')">‚Ä¢</button>
                    </div>
                    <div class="rte-editor" contenteditable="true" onblur="updateTemplateNodeNote('${cur.join(',')}', this.innerHTML)">${n.note||''}</div>`;
                div.appendChild(noteDiv);
            }
            
            ul.appendChild(div);
            if(n.subtasks && n.subtasks.length>0) ul.appendChild(build(n.subtasks, cur));
        });
        return ul;
    }
    c.appendChild(build(currentTemplateTree, []));
}
function updateTemplateNodeText(p,v){ getTemplateNode(p.split(',').map(Number)).text=v; }
function toggleTemplateNote(p){ const n=getTemplateNode(p.split(',').map(Number)); n.noteOpen=!n.noteOpen; renderTemplateTree(); }
function updateTemplateNodeNote(p,v){ getTemplateNode(p.split(',').map(Number)).note=v; }
function addRootTemplateItem(){ currentTemplateTree.push({text:"New Step",note:"",subtasks:[]}); renderTemplateTree(); }
function addTemplateSubNode(p){ getTemplateNode(p.split(',').map(Number)).subtasks.push({text:"Sub step",note:"",subtasks:[]}); renderTemplateTree(); }
function deleteTemplateNode(p){ const path=p.split(',').map(Number), idx=path.pop(), parent=path.length===0?{subtasks:currentTemplateTree}:getTemplateNode(path); parent.subtasks.splice(idx,1); renderTemplateTree(); }
function saveTemplate(){
    const name=document.getElementById('tpl-name-input').value.trim(); if(!name)return alert("Name required");
    // Clean up ui flags like noteOpen before saving
    const cleanTree = (t) => t.map(n => ({text:n.text, note:n.note, subtasks:cleanTree(n.subtasks||[])}));
    const finalTree = cleanTree(currentTemplateTree);
    if(editingTemplateId){ const t=taskTemplates.find(x=>x.id===editingTemplateId); t.name=name; t.subtasks=finalTree; }
    else taskTemplates.push({id:Date.now().toString(),name:name,subtasks:finalTree});
    localStorage.setItem('simpList-templates',JSON.stringify(taskTemplates)); showTemplateList();
}
function deleteTemplate(id){ if(confirm('Delete?')){ taskTemplates=taskTemplates.filter(x=>x.id!==id); localStorage.setItem('simpList-templates',JSON.stringify(taskTemplates)); showTemplateList(); }}

// --- FOLDERS ---
function renderButtonFolders(){
    const c=document.getElementById('folders-container'), q=document.getElementById('button-search').value.toLowerCase(); c.innerHTML='';
    if(buttonFolders.length===0){ c.innerHTML='<div style="color:#888;font-style:italic;padding:10px;">No folders.</div>'; return; }
    buttonFolders.forEach((f,fi)=>{
        if(f.collapsed===undefined)f.collapsed=false;
        let items=f.items||[]; if(q) items=items.filter(i=>i.name.toLowerCase().includes(q)||i.message.toLowerCase().includes(q));
        if(q && items.length===0)return;
        const div=document.createElement('div'); div.className='folder-div'; if(f.collapsed&&!q)div.classList.add('collapsed');
        div.draggable=true;
        div.ondragstart=(e)=>{ e.stopPropagation(); dragType='folder'; dragSrcFolderIndex=fi; e.dataTransfer.effectAllowed='move'; div.classList.add('dragging'); };
        div.ondragover=(e)=>{ if(dragType==='folder'){ e.preventDefault(); div.classList.add('drag-over'); }};
        div.ondragleave=()=>{ div.classList.remove('drag-over'); };
        div.ondrop=(e)=>{ if(dragType==='folder'){ e.stopPropagation(); div.classList.remove('drag-over'); div.classList.remove('dragging'); if(dragSrcFolderIndex!==fi){ const it=buttonFolders.splice(dragSrcFolderIndex,1)[0]; buttonFolders.splice(fi,0,it); saveButtonFolders(); }}};
        div.ondragend=()=>{ div.classList.remove('dragging'); };

        const head=document.createElement('div'); head.className='folder-header'; head.style.backgroundColor=f.color||'#2196f3'; head.style.color=getContrastYIQ(head.style.backgroundColor);
        head.innerHTML=`<div style="display:flex;align-items:center;"><span class="material-symbols-outlined drag-handle" title="Drag">drag_indicator</span><span style="font-weight:600">${escapeHtml(f.folderName)}</span></div><div class="controls"><button onclick="event.stopPropagation();openButtonModal('${f.id}',null)">+</button><button onclick="event.stopPropagation();openFolderModal('${f.id}')">‚öô</button></div>`;
        head.onclick=(e)=>{ if(!e.target.closest('button')&&!e.target.closest('.drag-handle')){ div.classList.toggle('collapsed'); f.collapsed=div.classList.contains('collapsed'); saveButtonFolders(); }};
        
        const list=document.createElement('div'); list.className='buttons-list';
        list.ondragover=(e)=>{ if(dragType==='button'){ e.preventDefault(); list.classList.add('drag-over'); }};
        list.ondragleave=()=>{ list.classList.remove('drag-over'); };
        list.ondrop=(e)=>{ if(dragType==='button'){ e.stopPropagation(); list.classList.remove('drag-over'); const src=buttonFolders[dragSrcFolderIndex], it=src.items.splice(dragSrcButtonIndex,1)[0]; f.items.push(it); saveButtonFolders(); }};

        items.forEach((item, ii)=>{
            const realIdx=f.items.indexOf(item);
            const btn=document.createElement('button'); btn.className='copy-box'; btn.style.backgroundColor=item.color||'#2196f3'; btn.style.color=getContrastYIQ(btn.style.backgroundColor);
            let prev=replaceTags(item.message); if(prev.length>300)prev=prev.substring(0,300)+'...';
            btn.innerHTML=`${escapeHtml(item.name)}<span class="tooltip">${escapeHtml(prev)}</span>`;
            btn.onclick=()=>copyToClipboard(item.message); btn.oncontextmenu=(e)=>{e.preventDefault(); openButtonModal(f.id, realIdx);};
            btn.draggable=true;
            btn.ondragstart=(e)=>{ e.stopPropagation(); dragType='button'; dragSrcFolderIndex=fi; dragSrcButtonIndex=realIdx; e.dataTransfer.effectAllowed='move'; btn.classList.add('dragging'); };
            btn.ondragend=()=>{ btn.classList.remove('dragging'); };
            btn.ondragover=(e)=>{ if(dragType==='button') e.preventDefault(); };
            btn.ondrop=(e)=>{ if(dragType==='button'){ e.stopPropagation(); const src=buttonFolders[dragSrcFolderIndex], it=src.items.splice(dragSrcButtonIndex,1)[0]; f.items.splice(realIdx,0,it); saveButtonFolders(); }};
            list.appendChild(btn);
        });
        div.appendChild(head); div.appendChild(list); c.appendChild(div);
    });
}
function saveButtonFolders(){ localStorage.setItem('foldersV2',JSON.stringify(buttonFolders)); renderButtonFolders(); }

// --- BUTTON MODALS ---
function openFolderModal(id){ editingFolderId=id; const m=document.getElementById('folder-modal'); if(id){const f=buttonFolders.find(x=>x.id===id); document.getElementById('folder-name-input').value=f.folderName; document.getElementById('folder-color-input').value=f.color; document.getElementById('folder-delete-btn').style.display='block';}else{document.getElementById('folder-name-input').value=''; document.getElementById('folder-delete-btn').style.display='none';} m.style.display='flex'; }
function closeFolderModal(){ document.getElementById('folder-modal').style.display='none'; }
function saveFolder(){ const n=document.getElementById('folder-name-input').value.trim(), c=document.getElementById('folder-color-input').value; if(!n)return alert("Name required"); if(editingFolderId){const f=buttonFolders.find(x=>x.id===editingFolderId); f.folderName=n; f.color=c;}else{buttonFolders.push({id:Date.now().toString(),folderName:n,color:c,items:[]});} saveButtonFolders(); closeFolderModal(); }
function deleteFolderHelper(){ if(confirm("Delete folder?")){ buttonFolders=buttonFolders.filter(x=>x.id!==editingFolderId); saveButtonFolders(); closeFolderModal(); }}

function openButtonModal(fid,idx){ targetFolderId=fid; editingBtnIndex=idx; const m=document.getElementById('btn-modal'), f=buttonFolders.find(x=>x.id===fid); if(!f)return;
const sel=document.getElementById('tag-inserter'); sel.innerHTML='<option value="">+ Tag</option>'+customTags.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
if(idx!==null){ const it=f.items[idx]; document.getElementById('btn-label-input').value=it.name; document.getElementById('btn-content-input').value=it.message; document.getElementById('btn-color-input').value=it.color; document.getElementById('btn-delete-btn').style.display='block'; }
else{ document.getElementById('btn-label-input').value=''; document.getElementById('btn-content-input').value=''; document.getElementById('btn-color-input').value=f.color; document.getElementById('btn-delete-btn').style.display='none'; } m.style.display='flex'; }
function insertTagIntoMessage(s){ if(!s.value)return; const t=document.getElementById('btn-content-input'), p=t.selectionStart; t.value=t.value.slice(0,p)+s.value+t.value.slice(t.selectionEnd); s.value=''; t.focus(); }
function closeBtnModal(){ document.getElementById('btn-modal').style.display='none'; }
function saveButton(){ const l=document.getElementById('btn-label-input').value.trim(), m=document.getElementById('btn-content-input').value.trim(), c=document.getElementById('btn-color-input').value; if(!l||!m)return alert("Fields required"); const f=buttonFolders.find(x=>x.id===targetFolderId); if(editingBtnIndex!==null)f.items[editingBtnIndex]={name:l,message:m,color:c}; else f.items.push({name:l,message:m,color:c}); saveButtonFolders(); closeBtnModal(); }
function deleteButtonHelper(){ if(confirm("Delete?")){ const f=buttonFolders.find(x=>x.id===targetFolderId); f.items.splice(editingBtnIndex,1); saveButtonFolders(); closeBtnModal(); }}
function copyToClipboard(t){ navigator.clipboard.writeText(replaceTags(t)).then(()=>{ const d=document.createElement('div'); d.innerText="Copied!"; d.style.cssText="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:6px 12px;border-radius:4px;z-index:2000;font-size:12px;"; document.body.appendChild(d); setTimeout(()=>d.remove(),1500); }); }

// --- SIMPLIST TASKS ---
function getTaskByPath(idx,path){ let t=cards[idx].tasks[path[0]]; for(let i=1;i<path.length;i++) t=t.subtasks[path[i]]; return t; }
function calculateProgress(t){ let tot=0,sc=0; function trav(n){ if(n.subtasks) n.subtasks.forEach(trav); tot++; if(n.status==='done')sc+=1; else if(n.status==='doing')sc+=0.5; } if(t.subtasks)t.subtasks.forEach(trav); return tot===0?0:(sc/tot)*100; }
function calculateCardProgress(c){ let tot=0,sc=0; function trav(n){ tot++; if(n.status==='done')sc+=1; else if(n.status==='doing')sc+=0.5; if(n.subtasks)n.subtasks.forEach(trav); } c.tasks.forEach(trav); return tot===0?0:(sc/tot)*100; }
function getStatusIcon(s){ return s==='done'?'check_circle':(s==='doing'?'timelapse':'radio_button_unchecked'); }
function cycleTaskStatus(idx,pathStr){ const t=getTaskByPath(idx,pathStr.split(',').map(Number)); t.status=(!t.status||t.status==='todo')?'doing':(t.status==='doing'?'done':'todo'); t.done=(t.status==='done'); localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); }

function moveTask(sIdx,sP,dIdx,dP,pos){
    if(sIdx===dIdx){
        const isChild=sP.every((v,i)=>dP[i]===v); if(isChild&&dP.length>sP.length)return;
        if(JSON.stringify(sP)===JSON.stringify(dP) && pos==='inside') return;
        if(pos!=='inside' && sP.length===dP.length){ const pS=sP.slice(0,-1),pD=dP.slice(0,-1); if(JSON.stringify(pS)===JSON.stringify(pD)){ const sI=sP[sP.length-1], dI=dP[dP.length-1]; if(sI===dI)return; if(pos==='after'&&sI===dI)return; if(pos==='before'&&sI===dI)return; }}
    }
    const mt=getTaskByPath(sIdx,sP); mt._del=true; const clone=JSON.parse(JSON.stringify(mt)); delete clone._del;
    if(pos==='inside'){ const tg=getTaskByPath(dIdx,dP); if(!tg.subtasks)tg.subtasks=[]; tg.subtasks.push(clone); tg.collapsed=false; }
    else if(pos==='inside-card'){ cards[dIdx].tasks.push(clone); }
    else{
        let list, idx; if(dP.length===1){ list=cards[dIdx].tasks; idx=dP[0]; } else { const p=getTaskByPath(dIdx,dP.slice(0,-1)); list=p.subtasks; idx=dP[dP.length-1]; }
        if(pos==='after') idx++; list.splice(idx,0,clone);
    }
    function sweep(l){ for(let i=l.length-1;i>=0;i--){ if(l[i]._del){ l.splice(i,1); return true; } if(l[i].subtasks && sweep(l[i].subtasks)) return true; } return false; }
    sweep(cards[sIdx].tasks); localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards();
}

function renderCards(){
    const c=document.getElementById('card-list'), q=document.getElementById('task-search').value.toLowerCase(); c.innerHTML='';
    cards.forEach((card,ci)=>{
        if(card.tasks){ const mig=(l)=>{l.forEach(t=>{if(!t.status)t.status=t.done?'done':'todo'; if(t.subtasks)mig(t.subtasks);});}; mig(card.tasks); }
        const div=document.createElement('div'); div.className='card-mat'; if(card.collapsed&&!q)div.classList.add('collapsed');
        div.ondragover=(e)=>{if(dragType==='card'){e.preventDefault();e.dataTransfer.dropEffect='move';}if(dragType==='task')e.preventDefault();};
        div.ondrop=(e)=>{e.stopPropagation();if(dragType==='card'&&dragSrcCardIndex!==ci){const it=cards.splice(dragSrcCardIndex,1)[0]; cards.splice(ci,0,it); localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards();} if(dragType==='task'&&!e.target.closest('.task-node'))moveTask(dragSrcCardIndex,dragSrcTaskPath,ci,[],'inside-card');};
        
        const hCol=card.color||'#f3edff'; const txtCol=getContrastYIQ(hCol);
        div.innerHTML=`<div class="card-header" style="background:${hCol};color:${txtCol}"><div style="flex:1;"><div style="display:flex;align-items:center;"><span class="material-symbols-outlined drag-handle card-drag-handle" draggable="true" title="Drag">drag_indicator</span><span style="font-size:1.1em;font-weight:600;">${escapeHtml(card.title)}</span></div><div class="progress-track" style="display:${card.tasks.length>0?'block':'none'}"><div class="progress-fill" style="width:${calculateCardProgress(card)}%"></div></div></div><div class="controls"><button onclick="event.stopPropagation();openListModal('${card.id}')">‚öô</button></div></div>`;
        const head=div.querySelector('.card-header');
        head.querySelector('.card-drag-handle').ondragstart=(e)=>{e.stopPropagation();dragSrcCardIndex=ci;dragType='card';e.dataTransfer.effectAllowed='move';div.classList.add('dragging');};
        head.querySelector('.card-drag-handle').ondragend=()=>{div.classList.remove('dragging');};
        head.onclick=(e)=>{if(!e.target.closest('.drag-handle')&&!e.target.closest('button')){div.classList.toggle('collapsed'); card.collapsed=div.classList.contains('collapsed'); localStorage.setItem('simpList-data',JSON.stringify(cards));}};
        
        const content=document.createElement('div'); content.className='card-content';
        const ul=document.createElement('div'); ul.className='task-list';
        
        function rTree(tasks,path){
            const wrap=document.createElement('div');
            tasks.forEach((t,i)=>{
                if(q && !JSON.stringify(t).toLowerCase().includes(q))return;
                const cur=[...path,i], pStr=cur.join(',');
                const nd=document.createElement('div'); nd.className='task-node';
                
                nd.ondragover=(e)=>{if(dragType!=='task')return; if(dragSrcCardIndex===ci && JSON.stringify(dragSrcTaskPath)===JSON.stringify(cur))return; e.preventDefault();e.stopPropagation(); const r=nd.getBoundingClientRect(), y=e.clientY-r.top; nd.classList.remove('drop-above','drop-below','drop-inside'); if(y<r.height*0.25)nd.classList.add('drop-above'); else if(y>r.height*0.75)nd.classList.add('drop-below'); else nd.classList.add('drop-inside');};
                nd.ondragleave=(e)=>{if(!nd.contains(e.relatedTarget))nd.classList.remove('drop-above','drop-below','drop-inside');};
                nd.ondrop=(e)=>{if(dragType!=='task')return; e.stopPropagation(); let pos='inside'; if(nd.classList.contains('drop-above'))pos='before'; else if(nd.classList.contains('drop-below'))pos='after'; nd.classList.remove('drop-above','drop-below','drop-inside'); moveTask(dragSrcCardIndex,dragSrcTaskPath,ci,cur,pos);};

                const pct=calculateProgress(t);
                const row=document.createElement('div'); row.className='task-row';
                
                const drag=document.createElement('span'); drag.className='material-symbols-outlined task-drag-handle'; drag.innerText='drag_indicator'; drag.draggable=true;
                drag.ondragstart=(e)=>{e.stopPropagation();dragType='task';dragSrcCardIndex=ci;dragSrcTaskPath=cur;e.dataTransfer.effectAllowed='move';nd.classList.add('dragging-task');};
                drag.ondragend=()=>{nd.classList.remove('dragging-task');document.querySelectorAll('.task-node').forEach(el=>el.classList.remove('drop-above','drop-below','drop-inside'));};
                
                const chev=document.createElement('span'); chev.className='material-symbols-outlined collapse-icon'; 
                if(t.subtasks&&t.subtasks.length>0){ chev.innerText=(q||!t.collapsed)?'expand_more':'chevron_right'; chev.onclick=()=>toggleTaskCollapse(ci,pStr); } else chev.classList.add('collapse-placeholder');
                
                const stat=document.createElement('span'); stat.className='material-symbols-outlined task-status-icon status-'+(t.status||'todo'); stat.innerText=getStatusIcon(t.status); stat.onclick=()=>cycleTaskStatus(ci,pStr);
                
                const txt=document.createElement('span'); txt.className='task-text '+(t.status==='done'?'task-done':''); txt.contentEditable=true; txt.textContent=t.text; txt.onblur=(e)=>updateTaskText(ci,pStr,e.target.innerText);
                
                // RICH NOTE TOGGLE
                const noteBtn=document.createElement('span'); noteBtn.className='material-symbols-outlined action-btn'+(t.note?' has-note':''); noteBtn.style.fontSize="16px"; noteBtn.innerText='sticky_note_2'; noteBtn.onclick=()=>toggleTaskNote(ci,pStr);

                const date=document.createElement('input'); date.type='date'; date.className='date-input '+(t.status!=='done'?getDateStatus(t.due):''); date.value=t.due||''; date.onchange=(e)=>updateTaskDate(ci,pStr,e.target.value);
                
                const add=document.createElement('span'); add.className='material-symbols-outlined action-btn'; add.innerText='playlist_add'; add.onclick=()=>addSubtask(ci,pStr);
                const del=document.createElement('span'); del.className='material-symbols-outlined action-btn delete'; del.innerText='delete'; del.onclick=()=>deleteTask(ci,pStr);
                
                row.append(drag,chev,stat,txt,noteBtn,date,add,del);
                if(t.subtasks&&t.subtasks.length>0&&pct<100){ const tr=document.createElement('div'); tr.className='node-progress-track'; const fl=document.createElement('div'); fl.className='node-progress-fill'; fl.style.width=pct+'%'; tr.appendChild(fl); row.appendChild(tr); }
                nd.appendChild(row);

                // RICH NOTE EDITOR
                if(t.noteOpen){
                    const noteDiv=document.createElement('div'); noteDiv.className='task-note-block';
                    noteDiv.innerHTML=`
                        <div class="rte-toolbar">
                            <button class="rte-btn" onmousedown="event.preventDefault();formatRichText('bold')">B</button>
                            <button class="rte-btn" onmousedown="event.preventDefault();formatRichText('italic')">I</button>
                            <button class="rte-btn" onmousedown="event.preventDefault();formatRichText('insertUnorderedList')">‚Ä¢</button>
                        </div>
                        <div class="rte-editor" contenteditable="true" onblur="updateTaskNote(${ci},'${pStr}',this.innerHTML)">${t.note||''}</div>`;
                    nd.appendChild(noteDiv);
                }

                if(t.subtasks&&t.subtasks.length>0){ const ch=document.createElement('div'); ch.className='task-children'; if(t.collapsed&&!q)ch.classList.add('hidden'); ch.appendChild(rTree(t.subtasks,cur)); nd.appendChild(ch); }
                wrap.appendChild(nd);
            });
            return wrap;
        }
        ul.appendChild(rTree(card.tasks,[]));
        
        let tplOpts=''; taskTemplates.forEach(t=>{tplOpts+=`<div class="mini-menu-item" onclick="insertTemplateTask(${ci},'${t.id}')">${escapeHtml(t.name)}</div>`});
        const addRow=document.createElement('div'); addRow.className='add-task-row';
        addRow.innerHTML=`<input type="text" id="add-input-${ci}" class="add-task-input" placeholder="+ Task" onkeydown="if(event.key==='Enter')addTask(${ci},this)">
        <div style="position:relative;"><button class="template-picker-btn" onclick="document.getElementById('tpl-menu-${ci}').style.display=document.getElementById('tpl-menu-${ci}').style.display==='block'?'none':'block'"><span class="material-symbols-outlined" style="font-size:16px">post_add</span></button><div id="tpl-menu-${ci}" class="mini-menu"><div class="mini-menu-item" style="color:#888;cursor:default;">Template...</div>${tplOpts||'<div style="padding:5px;color:#999;">None</div>'}<div class="mini-menu-item" style="color:#2196f3;border-top:1px solid #eee;" onclick="openTemplateManager()">Manage</div></div></div>`;
        
        content.appendChild(ul); content.appendChild(addRow); div.appendChild(head); div.appendChild(content); c.appendChild(div);
    });
}
window.onclick=(e)=>{ if(!e.target.closest('.template-picker-btn'))document.querySelectorAll('.mini-menu').forEach(e=>e.style.display='none'); };

// --- TASK ACTIONS ---
function openListModal(id){ editingListId=id; const m=document.getElementById('list-modal'); if(id){const c=cards.find(x=>x.id===id);document.getElementById('list-name-input').value=c.title;document.getElementById('list-color-input').value=c.color;document.getElementById('list-delete-btn').style.display='block';}else{document.getElementById('list-name-input').value='';document.getElementById('list-color-input').value='#673ab7';document.getElementById('list-delete-btn').style.display='none';} m.style.display='flex'; }
function closeListModal(){ document.getElementById('list-modal').style.display='none'; }
function saveList(){ const n=document.getElementById('list-name-input').value.trim(), c=document.getElementById('list-color-input').value; if(!n)return alert("Name required"); if(editingListId){const k=cards.find(x=>x.id===editingListId); k.title=n; k.color=c;}else{cards.push({id:Date.now().toString(),title:n,color:c,tasks:[],collapsed:false});} localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); closeListModal(); }
function deleteListHelper(){ if(confirm("Delete list?")){ cards=cards.filter(x=>x.id!==editingListId); localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); closeListModal(); }}

function addTask(i,inp){ if(!inp.value.trim())return; cards[i].tasks.push({text:inp.value,status:'todo',done:false,due:'',note:'',subtasks:[],collapsed:false}); inp.value=''; renderCards(); setTimeout(()=>{const x=document.querySelectorAll('.add-task-input')[i];if(x)x.focus();},50); localStorage.setItem('simpList-data',JSON.stringify(cards)); }
function cloneTask(t){ return {text:t.text,status:'todo',done:false,due:'',note:t.note||'',collapsed:false,subtasks:t.subtasks?t.subtasks.map(cloneTask):[]}; }
function insertTemplateTask(i,tid){ const t=taskTemplates.find(x=>x.id===tid), inp=document.getElementById(`add-input-${i}`), txt=inp.value.trim()||t.name; cards[i].tasks.push({text:txt,status:'todo',done:false,due:'',note:t.note||'',collapsed:false,subtasks:t.subtasks?t.subtasks.map(cloneTask):[]}); inp.value=''; localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); }

function toggleTaskCollapse(i,p){ const t=getTaskByPath(i,p.split(',').map(Number)); t.collapsed=!t.collapsed; localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); }
function toggleTaskNote(i,p){ const t=getTaskByPath(i,p.split(',').map(Number)); t.noteOpen=!t.noteOpen; localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); }
function updateTaskNote(i,p,v){ const t=getTaskByPath(i,p.split(',').map(Number)); t.note=v; localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); } // Re-render to update icon color
function addSubtask(i,p){ const t=getTaskByPath(i,p.split(',').map(Number)); if(!t.subtasks)t.subtasks=[]; t.subtasks.push({text:"New Step",status:'todo',done:false,due:'',note:'',collapsed:false,subtasks:[]}); t.collapsed=false; localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); }
function deleteTask(i,p){ const path=p.split(',').map(Number), idx=path.pop(); if(path.length===0)cards[i].tasks.splice(idx,1); else getTaskByPath(i,path).subtasks.splice(idx,1); localStorage.setItem('simpList-data',JSON.stringify(cards)); renderCards(); }
function updateTaskText(i,p,v){ getTaskByPath(i,p.split(',').map(Number)).text=v; localStorage.setItem('simpList-data',JSON.stringify(cards)); }
function updateTaskDate(i,p,v){ getTaskByPath(i,p.split(',').map(Number)).due=v; renderCards(); localStorage.setItem('simpList-data',JSON.stringify(cards)); }

// --- EXPORT ---
function exportData(){ const d={folders:buttonFolders,customTags:customTags,cards:cards,templates:taskTemplates}; const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='simplist_backup.json'; a.click(); }
document.getElementById('file-upload').addEventListener('change',function(e){ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(ev){ try{const d=JSON.parse(ev.target.result); if(d.folders)buttonFolders=d.folders; if(d.cards)cards=d.cards; if(d.customTags)customTags=d.customTags; if(d.templates)taskTemplates=d.templates; saveButtonFolders(); localStorage.setItem('customTags',JSON.stringify(customTags)); localStorage.setItem('simpList-data',JSON.stringify(cards)); localStorage.setItem('simpList-templates',JSON.stringify(taskTemplates)); renderCards(); alert('Import successful!');}catch(err){alert('Error');}}; r.readAsText(f); });

renderButtonFolders(); renderCards();
</script>
</body>
</html>