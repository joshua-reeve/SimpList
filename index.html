<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simplist</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <style>
    /* --- Simplist Base Styles (COMPACT MODE) --- */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      min-height: 100vh;
      font-size: 13px; /* Reduced from 16px/default */
    }
    .topbar {
      display: flex;
      align-items: center;
      background: #2196F3;
      color: white;
      padding: 0 12px; /* Reduced padding */
      height: 40px;    /* Reduced height from 48px */
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      gap: 8px;
    }
    .topbar h1 { font-size: 1.1rem; margin: 0; font-weight: 500; }
    .topbar .spacer { flex: 1; }
    .topbar .icon-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 20px; /* Smaller icons */
      padding: 6px;
      border-radius: 50%;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .topbar .icon-btn:hover { background: rgba(255,255,255,0.15); }

    .container {
      padding: 15px 10px; /* Tighter padding */
      max-width: 1200px;
      margin: 0 auto;
    }

    /* --- Custom Button / Clipboard Manager Styles --- */
    #custom-buttons-section {
      margin-top: 30px; 
      border-top: 1px solid #ddd; 
      padding-top: 15px;
      animation: fadeIn 0.4s ease;
    }
    
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    .search-input {
      flex: 1;
      padding: 6px 12px; /* Compact input */
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 13px;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
      border-color: #2196f3;
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    /* FOLDERS & LISTS COMMON STYLES */
    .folder-div, .card-mat {
      background: #fff;
      border-radius: 6px;
      margin-bottom: 8px; /* Reduced margin (50% closer) */
      overflow: visible; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    /* Dragging Visuals */
    .folder-div.dragging, .card-mat.dragging {
      opacity: 0.4;
      border: 2px dashed #2196f3;
    }
    .folder-div.drag-over, .buttons-list.drag-over {
        background-color: #e3f2fd;
        border: 2px dashed #2196f3;
    }

    .folder-header, .card-header {
      padding: 6px 10px; /* Tighter header */
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
      transition: filter 0.2s;
      border-radius: 5px 5px 0 0;
    }
    
    .folder-div.collapsed .folder-header,
    .card-mat.collapsed .card-header {
      border-radius: 5px;
    }

    .folder-header:hover, .card-header:hover { filter: brightness(1.05); }
    .folder-header .title-area, .card-header .title-area { display: flex; align-items: center; gap: 6px; flex: 1; }
    
    .controls button {
      background: rgba(255,255,255,0.3);
      border: none;
      color: inherit;
      margin-left: 4px;
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .controls button:hover { background: rgba(255,255,255,0.5); }
    
    .buttons-list, .card-content {
      padding: 8px; /* Reduced content padding */
      background: #fff;
      border-radius: 0 0 5px 5px;
    }
    
    .folder-div.collapsed .buttons-list,
    .card-mat.collapsed .card-content {
      display: none;
    }
    
    .buttons-list {
       display: flex;
       flex-wrap: wrap;
       gap: 6px; /* Tighter buttons */
       background: #f9f9f9; 
       min-height: 30px; 
    }

    .progress-track {
      height: 3px;
      background: rgba(0,0,0,0.1);
      border-radius: 2px;
      margin-top: 4px;
      width: 100%;
      overflow: hidden;
      display: none; 
    }
    .progress-fill {
      height: 100%;
      background: rgba(255,255,255,0.8);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .copy-box {
      position: relative;
      padding: 5px 10px; /* Smaller copy buttons */
      border-radius: 15px;
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 12px;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transition: transform 0.1s, box-shadow 0.15s, filter 0.15s;
      display: flex;
      align-items: center;
      user-select: none;
    }
    .copy-box:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      filter: brightness(1.05);
      z-index: 1000;
    }
    .copy-box:active { transform: scale(0.96); }
    .copy-box.dragging { opacity: 0.5; border: 2px dashed #333; }

    .tooltip {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 6px 10px;
      position: absolute;
      z-index: 9999;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      width: max-content;
      max-width: 250px;
      font-size: 11px;
      font-weight: normal;
      pointer-events: none;
      white-space: pre-wrap;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      line-height: 1.3;
    }
    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    .copy-box:hover .tooltip { visibility: visible; opacity: 1; }

    /* --- Simplist Task Styles --- */
    .card-list { 
        display: flex; 
        flex-direction: column; 
        gap: 10px; /* 50% Closer task lists (was 20px) */
    }
    .task-list { list-style: none; padding: 0; margin: 0; min-height: 15px; }
    
    .task-node { 
        border-bottom: 1px solid #f0f0f0; 
        padding: 4px 0; /* Tighter rows */
        border: 2px solid transparent; 
        border-radius: 4px;
        transition: border-color 0.1s, background-color 0.1s;
    }
    .task-node.dragging-task { opacity: 0.4; }
    .task-node.drop-above { border-top: 2px solid #2196f3; }
    .task-node.drop-below { border-bottom: 2px solid #2196f3; }
    .task-node.drop-inside { background-color: #e8f5e9; border: 2px dashed #4caf50; }
    
    .task-children { margin-left: 20px; border-left: 1px solid #eee; padding-left: 6px; }
    .task-children.hidden { display: none; }
    .task-row { display: flex; align-items: center; gap: 6px; padding: 2px 0; }
    
    /* STATUS ICONS (Compact) */
    .task-status-icon { 
        cursor: pointer; 
        user-select: none; 
        font-size: 18px; /* Smaller icon */
        width: 18px; height: 18px;
        transition: color 0.2s, transform 0.1s;
    }
    .task-status-icon:active { transform: scale(0.9); }
    .status-todo { color: #bdbdbd; }
    .status-doing { color: #fb8c00; }
    .status-done { color: #4caf50; }

    .task-text { flex: 1; margin: 0; outline: none; font-size: 13px; line-height: 1.4; padding: 2px 4px; border-radius: 4px; border: 1px solid transparent; cursor: text; }
    .task-text:focus { background: #fff; border-color:#ddd; }
    .task-done { text-decoration: line-through; color: #888; }
    
    .date-input { border: 1px solid #ddd; border-radius: 4px; padding: 2px; font-size: 10px; color: #666; font-family: inherit; background: #f9f9f9; cursor: pointer; max-width: 90px; }
    .date-input:hover { background: #eee; }
    .date-input.overdue { border-color: #e57373; color: #d32f2f; background: #ffebee; }
    .date-input.upcoming { border-color: #ffb74d; color: #e65100; background: #fff3e0; }
    
    .node-progress-track { height: 3px; background: #eee; border-radius: 2px; margin-top: 2px; margin-left: 24px; overflow: hidden; width: 80px; display: inline-block; vertical-align: middle; margin-right: 8px; }
    .node-progress-fill { height: 100%; background: #4caf50; transition: width 0.3s; }
    
    .action-btn { color: #ccc; cursor: pointer; font-size: 16px; user-select: none; }
    .action-btn:hover { color: #2196f3; }
    .action-btn.delete:hover { color: #e57373; }
    
    .collapse-icon { cursor: pointer; font-size: 18px; color: #999; user-select: none; width: 18px; display: inline-flex; justify-content: center; }
    .collapse-icon:hover { color: #555; }
    .collapse-placeholder { width: 18px; }
    
    .add-task-row { display: flex; gap: 8px; margin-top: 10px; }
    .add-task-input { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; outline: none; font-size: 13px; }
    .add-task-input:focus { border-color: #2196f3; }
    .template-picker-btn { background: #e3f2fd; color: #2196f3; border: none; border-radius: 4px; cursor: pointer; padding: 0 8px; display: flex; align-items: center; justify-content: center; }
    .template-picker-btn:hover { background: #bbdefb; }
    
    /* Drag Handle Styles (Compact) */
    .drag-handle { cursor: grab; margin-right: 4px; color: rgba(0,0,0,0.2); font-size: 18px; user-select: none; }
    .drag-handle:hover { color: rgba(0,0,0,0.4); }
    .drag-handle:active { cursor: grabbing; }
    
    .card-drag-handle { cursor: grab; } 
    
    .task-drag-handle { 
        cursor: grab; 
        color: #ddd; 
        font-size: 16px; 
        margin-right: 2px; 
        user-select: none;
    }
    .task-drag-handle:hover { color: #999; }
    .task-drag-handle:active { cursor: grabbing; color: #2196f3; }

    /* --- Modals (Compact) --- */
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 10000; }
    .modal { background: white; padding: 20px; border-radius: 8px; width: 500px; max-width: 95%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 90vh; display: flex; flex-direction: column; }
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; margin-bottom: 4px; font-weight: 500; color: #555; font-size: 12px; }
    .input-group input[type="text"], .input-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: 13px; }
    .input-group input[type="color"] { width: 100%; height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
    .modal-actions-right { display: flex; gap: 8px; margin-left: auto; }
    .btn-primary { background: #2196f3; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 13px; }
    .btn-secondary { background: #ddd; color: #333; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .btn-danger { background: #e57373; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .tags-list-container { max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 12px; padding: 4px; border-radius: 4px; }
    .tag-item { display: flex; justify-content: space-between; align-items: center; padding: 6px; background: #f9f9f9; margin-bottom: 4px; border-radius: 4px; font-size: 13px; }
    .tag-item:last-child { margin-bottom: 0; }
    .tag-key { font-weight: bold; color: #2196f3; margin-right: 10px; }
    .tag-actions { display:flex; gap: 4px; }
    .mini-menu { position: absolute; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-radius: 4px; padding: 4px 0; z-index: 5000; width: 180px; max-height: 250px; overflow-y: auto; display: none; right: 0; bottom: 100%; }
    .mini-menu-item { padding: 6px 12px; cursor: pointer; font-size: 13px; color: #333; }
    .mini-menu-item:hover { background: #f0f0f0; color: #2196f3; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="topbar">
  <span class="material-symbols-outlined" style="font-size: 22px;">checklist</span>
  <h1>Simplist</h1>
  <div class="spacer"></div>
  <button class="icon-btn" onclick="exportData()" title="Export Data"><span class="material-symbols-outlined">download</span></button>
  <button class="icon-btn" onclick="document.getElementById('file-upload').click()" title="Import Data"><span class="material-symbols-outlined">upload</span></button>
  <input type="file" id="file-upload" style="display:none" accept=".json,.html,.txt">
</div>

<div class="container">
  
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; margin-top:15px;">
    <h2 style="margin:0; font-size:1.2rem; color:#444;">Task Lists</h2>
    <div style="display:flex; gap:8px;">
        <button class="btn-secondary" onclick="openTemplateManager()">
            <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle;">extension</span> Templates
        </button>
        <button class="btn-primary" onclick="openListModal(null)">+ New List</button>
    </div>
  </div>
  
  <div class="search-row">
      <input type="text" id="task-search" class="search-input" placeholder="Search tasks..." onkeyup="renderCards()">
  </div>
  
  <div class="card-list" id="card-list">
    </div>

  <div id="custom-buttons-section">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <h2 style="margin:0; font-size:1.2rem; color:#444;">Quick Copy Buttons</h2>
      <div style="display:flex; gap:8px;">
        <button class="btn-secondary" onclick="openTagsModal()">
          <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle;">sell</span> Manage Tags
        </button>
        <button class="btn-primary" onclick="openFolderModal(null)">+ New Folder</button>
      </div>
    </div>
    
    <div class="search-row">
      <input type="text" id="button-search" class="search-input" placeholder="Search buttons..." onkeyup="renderButtonFolders()">
    </div>

    <div id="folders-container"></div>
  </div>

</div>

<div id="folder-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="folder-modal-title" style="margin-top:0; font-size:1.2rem;">Folder Settings</h3>
    <div class="input-group">
      <label>Folder Name</label>
      <input type="text" id="folder-name-input" placeholder="e.g. Work Emails">
    </div>
    <div class="input-group">
      <label>Folder Color</label>
      <input type="color" id="folder-color-input" value="#2196f3">
    </div>
    <div class="modal-actions">
       <button id="folder-delete-btn" class="btn-danger" style="display:none;" onclick="deleteFolderHelper()">Delete Folder</button>
       <div class="modal-actions-right">
          <button class="btn-secondary" onclick="closeFolderModal()">Cancel</button>
          <button class="btn-primary" onclick="saveFolder()">Save</button>
       </div>
    </div>
  </div>
</div>

<div id="list-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="list-modal-title" style="margin-top:0; font-size:1.2rem;">List Settings</h3>
    <div class="input-group">
      <label>List Name</label>
      <input type="text" id="list-name-input" placeholder="e.g. Shopping List">
    </div>
    <div class="input-group">
      <label>List Header Color</label>
      <input type="color" id="list-color-input" value="#673ab7">
    </div>
    <div class="modal-actions">
       <button id="list-delete-btn" class="btn-danger" style="display:none;" onclick="deleteListHelper()">Delete List</button>
       <div class="modal-actions-right">
          <button class="btn-secondary" onclick="closeListModal()">Cancel</button>
          <button class="btn-primary" onclick="saveList()">Save</button>
       </div>
    </div>
  </div>
</div>

<div id="btn-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="btn-modal-title" style="margin-top:0; font-size:1.2rem;">Add Copy Button</h3>
    <div class="input-group">
      <label>Button Label</label>
      <input type="text" id="btn-label-input" placeholder="e.g. Appointment Reminder">
    </div>
    <div class="input-group">
      <label>Message Content</label>
      <textarea id="btn-content-input" rows="4" placeholder="Text to copy..."></textarea>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
        <small style="color:#666;">Supports [Date], [Time] and Custom Tags.</small>
        <select id="tag-inserter" style="font-size:11px; padding:2px;" onchange="insertTagIntoMessage(this)">
            <option value="">+ Insert Tag</option>
        </select>
      </div>
    </div>
    <div class="input-group">
      <label>Button Color</label>
      <input type="color" id="btn-color-input" value="#2196f3">
    </div>
    <div class="modal-actions">
      <button id="btn-delete-btn" class="btn-danger" style="display:none;" onclick="deleteButtonHelper()">Delete</button>
      <div class="modal-actions-right">
        <button class="btn-secondary" onclick="closeBtnModal()">Cancel</button>
        <button class="btn-primary" onclick="saveButton()">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="tags-modal" class="modal-overlay">
    <div class="modal">
      <h3 style="margin-top:0; font-size:1.2rem;">Manage Custom Tags</h3>
      <p style="font-size:12px; color:#666; margin-top:-8px;">Tags will be replaced in your messages automatically.</p>
      
      <div id="tags-list" class="tags-list-container"></div>
      
      <div style="border-top:1px solid #eee; padding-top:12px;">
          <h4 id="tag-form-title" style="margin:0 0 8px 0; font-size:13px;">Add New Tag</h4>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
              <input type="text" id="new-tag-key" placeholder="Tag (e.g. [Name])" style="flex:1;">
              <input type="text" id="new-tag-val" placeholder="Value (e.g. John)" style="flex:1;">
          </div>
          <div style="display:flex; gap:5px;">
            <button id="tag-cancel-btn" class="btn-secondary" style="display:none; flex:1;" onclick="cancelEditTag()">Cancel</button>
            <button id="tag-save-btn" class="btn-primary" style="flex:1;" onclick="saveCustomTag()">Add Tag</button>
          </div>
      </div>
  
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeTagsModal()">Close</button>
      </div>
    </div>
</div>

<div id="template-modal" class="modal-overlay">
    <div class="modal">
        <h3 style="margin-top:0; font-size:1.2rem;">Task Templates</h3>
        <p style="font-size:12px; color:#666; margin-top:-8px;">Create templates to quickly add tasks with deep structure.</p>

        <div id="tpl-list-view">
            <div id="tpl-list" class="tags-list-container" style="min-height:150px;"></div>
            <button class="btn-primary" style="width:100%; margin-top:8px;" onclick="showTemplateEditor(null)">+ Create New Template</button>
        </div>

        <div id="tpl-editor-view" style="display:none;">
            <div class="input-group">
                <label>Template Name (Task Title)</label>
                <input type="text" id="tpl-name-input" placeholder="e.g. New Client Onboarding">
            </div>
            
            <label style="display:block; margin-bottom:4px; font-weight:500; color:#555; font-size:12px;">Template Structure</label>
            <div id="tpl-tree-container" class="tags-list-container" style="max-height:220px; background:#fafafa; border:1px solid #ddd;">
                </div>
            <button class="btn-secondary" style="width:100%; margin-top:5px; font-size:12px;" onclick="addRootTemplateItem()">+ Add Step</button>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="showTemplateList()">Back</button>
                <button class="btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>

        <div class="modal-actions" id="tpl-main-actions">
            <button class="btn-secondary" onclick="closeTemplateManager()">Close</button>
        </div>
    </div>
</div>

<script>
/**
 * --- PART 1: UTILITIES ---
 */
function getContrastYIQ(hexcolor){
    if (!hexcolor) return 'white';
    if(hexcolor.length === 4) { 
        hexcolor = '#' + hexcolor[1] + hexcolor[1] + hexcolor[2] + hexcolor[2] + hexcolor[3] + hexcolor[3];
    }
    var r = parseInt(hexcolor.substr(1,2),16);
    var g = parseInt(hexcolor.substr(3,2),16);
    var b = parseInt(hexcolor.substr(5,2),16);
    var yiq = ((r*299)+(g*587)+(b*114))/1000;
    return (yiq >= 128) ? '#212121' : 'white';
}

function escapeHtml(text) {
  if(!text) return '';
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
}

function replaceTags(text) {
  const now = new Date();
  const dateStr = now.toLocaleDateString();
  const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  let result = text.replace(/\[Date\]/gi, dateStr).replace(/\[Time\]/gi, timeStr);
  customTags.forEach(tag => {
      const regex = new RegExp(escapeRegExp(tag.name), 'gi');
      result = result.replace(regex, tag.value);
  });
  return result;
}

function getDateStatus(dateStr) {
    if(!dateStr) return '';
    const today = new Date();
    today.setHours(0,0,0,0);
    const due = new Date(dateStr + "T00:00:00");
    const diffTime = due - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    if (diffDays < 0) return 'overdue';
    if (diffDays >= 0 && diffDays <= 7) return 'upcoming';
    return '';
}

/**
 * --- PART 2: DATA & STATE ---
 */
// Data Fix: Ensure folders array exists and check for saved collapsed state
let buttonFolders = JSON.parse(localStorage.getItem('foldersV2')) || [];
if(Array.isArray(buttonFolders)) {
    buttonFolders.forEach(f => {
        if(f.collapsed === undefined) f.collapsed = false;
    });
}

let customTags = JSON.parse(localStorage.getItem('customTags')) || [
    {name: '[MyName]', value: 'Your Name'},
    {name: '[Phone]', value: '555-0199'}
];
let cards = JSON.parse(localStorage.getItem('simplist-data')) || [
  { id: '1', title: 'To Do', color:'#673ab7', tasks: [{text: 'Welcome to Simplist!', status:'todo', due:'', subtasks:[]}] }
];
// Ensure card collapsed state exists
if(Array.isArray(cards)) {
    cards.forEach(c => { if(c.collapsed === undefined) c.collapsed = false; });
}

let taskTemplates = JSON.parse(localStorage.getItem('simplist-templates')) || [];

let currentTemplateTree = []; 

// Modals State
let editingFolderId = null; 
let editingBtnIndex = null;
let targetFolderId = null; 
let editingTagIndex = null;
let editingListId = null; 
let editingTemplateId = null;

// Drag State
let dragSrcIndex = null; // For cards
let dragType = null; // 'card', 'folder', 'button', 'task'
let dragSrcFolderIndex = null;
let dragSrcButtonIndex = null;
let dragSrcTaskPath = null;
let dragSrcCardIndex = null;

/**
 * --- PART 3: TAGS MANAGER ---
 */
function openTagsModal() {
    renderTagsList();
    cancelEditTag(); 
    document.getElementById('tags-modal').style.display = 'flex';
}
function closeTagsModal() {
    document.getElementById('tags-modal').style.display = 'none';
}
function renderTagsList() {
    const list = document.getElementById('tags-list');
    list.innerHTML = '';
    if(customTags.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No custom tags yet.</div>';
        return;
    }
    customTags.forEach((tag, idx) => {
        const item = document.createElement('div');
        item.className = 'tag-item';
        if(idx === editingTagIndex) {
            item.style.border = "1px solid #2196f3";
            item.style.background = "#e3f2fd";
        }
        item.innerHTML = `
            <div style="overflow:hidden;">
                <span class="tag-key">${escapeHtml(tag.name)}</span>
                <span>&rarr; ${escapeHtml(tag.value)}</span>
            </div>
            <div class="tag-actions">
                <button onclick="editCustomTag(${idx})" title="Edit" style="border:none; background:none; color:#FFA000; cursor:pointer;">
                    <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                </button>
                <button onclick="deleteCustomTag(${idx})" title="Delete" style="border:none; background:none; color:#e57373; cursor:pointer;">
                    <span class="material-symbols-outlined" style="font-size:16px;">close</span>
                </button>
            </div>
        `;
        list.appendChild(item);
    });
}
function editCustomTag(idx) {
    editingTagIndex = idx;
    const tag = customTags[idx];
    document.getElementById('new-tag-key').value = tag.name;
    document.getElementById('new-tag-val').value = tag.value;
    document.getElementById('tag-form-title').innerText = "Edit Tag";
    document.getElementById('tag-save-btn').innerText = "Update Tag";
    document.getElementById('tag-cancel-btn').style.display = "inline-block";
    renderTagsList(); 
}
function cancelEditTag() {
    editingTagIndex = null;
    document.getElementById('new-tag-key').value = '';
    document.getElementById('new-tag-val').value = '';
    document.getElementById('tag-form-title').innerText = "Add New Tag";
    document.getElementById('tag-save-btn').innerText = "Add Tag";
    document.getElementById('tag-cancel-btn').style.display = "none";
    renderTagsList();
}
function saveCustomTag() {
    const key = document.getElementById('new-tag-key').value.trim();
    const val = document.getElementById('new-tag-val').value.trim();
    if(!key || !val) return alert("Please enter both a Tag (like [Name]) and a Value.");
    if (editingTagIndex !== null) {
        customTags[editingTagIndex] = { name: key, value: val };
    } else {
        customTags.push({ name: key, value: val });
    }
    localStorage.setItem('customTags', JSON.stringify(customTags));
    cancelEditTag();
}
function deleteCustomTag(idx) {
    if(confirm("Delete this tag?")) {
        if(editingTagIndex === idx) cancelEditTag();
        else if(editingTagIndex !== null && idx < editingTagIndex) editingTagIndex--; 
        customTags.splice(idx, 1);
        localStorage.setItem('customTags', JSON.stringify(customTags));
        renderTagsList();
    }
}

/**
 * --- PART 3.5: TEMPLATE MANAGER ---
 */
function openTemplateManager() {
    showTemplateList();
    document.getElementById('template-modal').style.display = 'flex';
}
function closeTemplateManager() {
    document.getElementById('template-modal').style.display = 'none';
}
function showTemplateList() {
    document.getElementById('tpl-list-view').style.display = 'block';
    document.getElementById('tpl-editor-view').style.display = 'none';
    document.getElementById('tpl-main-actions').style.display = 'flex';
    
    const list = document.getElementById('tpl-list');
    list.innerHTML = '';
    
    if(taskTemplates.length === 0) {
        list.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">No templates found.</div>';
        return;
    }
    
    taskTemplates.forEach(t => {
        const div = document.createElement('div');
        div.className = 'tag-item';
        div.innerHTML = `
            <div><strong>${escapeHtml(t.name)}</strong></div>
            <div class="tag-actions">
                <button onclick="showTemplateEditor('${t.id}')" style="border:none; background:none; color:#2196f3; cursor:pointer;"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button>
                <button onclick="deleteTemplate('${t.id}')" style="border:none; background:none; color:#e57373; cursor:pointer;"><span class="material-symbols-outlined" style="font-size:16px;">delete</span></button>
            </div>
        `;
        list.appendChild(div);
    });
}

function cloneTree(tree) {
    return tree.map(node => ({
        text: node.text,
        subtasks: node.subtasks ? cloneTree(node.subtasks) : []
    }));
}

function showTemplateEditor(id) {
    editingTemplateId = id;
    document.getElementById('tpl-list-view').style.display = 'none';
    document.getElementById('tpl-editor-view').style.display = 'block';
    document.getElementById('tpl-main-actions').style.display = 'none';
    
    if(id) {
        const tpl = taskTemplates.find(t => t.id === id);
        document.getElementById('tpl-name-input').value = tpl.name;
        currentTemplateTree = cloneTree(tpl.subtasks || []); 
    } else {
        document.getElementById('tpl-name-input').value = '';
        currentTemplateTree = [{text: "New Step", subtasks:[]}]; 
    }
    renderTemplateTree();
}

function getTemplateNode(path) {
    let node = { subtasks: currentTemplateTree };
    for (let i of path) {
        node = node.subtasks[i];
    }
    return node;
}

function renderTemplateTree() {
    const container = document.getElementById('tpl-tree-container');
    container.innerHTML = '';
    function buildNode(nodes, path) {
        const ul = document.createElement('div');
        ul.style.paddingLeft = path.length > 0 ? '20px' : '0';
        
        nodes.forEach((node, idx) => {
            const currentPath = [...path, idx];
            const row = document.createElement('div');
            row.style.marginBottom = "5px";
            row.style.display = "flex";
            row.style.gap = "5px";
            
            row.innerHTML = `
                <input type="text" value="${escapeHtml(node.text)}" 
                    onchange="updateTemplateNodeText('${currentPath.join(',')}', this.value)"
                    style="flex:1; padding:5px; border:1px solid #ddd; border-radius:3px; font-size:13px;">
                <button title="Add Sub-step" onclick="addTemplateSubNode('${currentPath.join(',')}')" style="border:none; background:#e3f2fd; color:#2196f3; cursor:pointer; border-radius:3px; padding:0 5px;">+</button>
                <button title="Delete" onclick="deleteTemplateNode('${currentPath.join(',')}')" style="border:none; background:#ffebee; color:#e57373; cursor:pointer; border-radius:3px; padding:0 5px;">&times;</button>
            `;
            
            ul.appendChild(row);
            if(node.subtasks && node.subtasks.length > 0) {
                ul.appendChild(buildNode(node.subtasks, currentPath));
            }
        });
        return ul;
    }
    container.appendChild(buildNode(currentTemplateTree, []));
}

function updateTemplateNodeText(pathStr, val) {
    const path = pathStr.split(',').map(Number);
    const node = getTemplateNode(path);
    node.text = val;
}
function addRootTemplateItem() {
    currentTemplateTree.push({ text: "New Step", subtasks: [] });
    renderTemplateTree();
}
function addTemplateSubNode(pathStr) {
    const path = pathStr.split(',').map(Number);
    const node = getTemplateNode(path);
    if(!node.subtasks) node.subtasks = [];
    node.subtasks.push({ text: "Sub step", subtasks: [] });
    renderTemplateTree();
}
function deleteTemplateNode(pathStr) {
    const path = pathStr.split(',').map(Number);
    const idx = path.pop();
    const parent = path.length === 0 ? {subtasks: currentTemplateTree} : getTemplateNode(path);
    parent.subtasks.splice(idx, 1);
    renderTemplateTree();
}

function saveTemplate() {
    const name = document.getElementById('tpl-name-input').value.trim();
    if(!name) return alert("Template name required");
    
    if(editingTemplateId) {
        const tpl = taskTemplates.find(t => t.id === editingTemplateId);
        tpl.name = name;
        tpl.subtasks = currentTemplateTree;
    } else {
        taskTemplates.push({
            id: Date.now().toString(),
            name: name,
            subtasks: currentTemplateTree
        });
    }
    
    localStorage.setItem('simplist-templates', JSON.stringify(taskTemplates));
    showTemplateList();
}
function deleteTemplate(id) {
    if(confirm('Delete template?')) {
        taskTemplates = taskTemplates.filter(t => t.id !== id);
        localStorage.setItem('simplist-templates', JSON.stringify(taskTemplates));
        showTemplateList();
    }
}

/**
 * --- PART 4: FOLDER & BUTTON RENDER ---
 */
function renderButtonFolders() {
  const container = document.getElementById('folders-container');
  const searchQuery = document.getElementById('button-search').value.toLowerCase();
  container.innerHTML = '';

  if (buttonFolders.length === 0) {
    container.innerHTML = '<div style="color:#888; font-style:italic; padding:10px;">No folders yet. Click "+ New Folder" to start.</div>';
    return;
  }

  buttonFolders.forEach((folder, fIndex) => {
    // Ensure data integrity
    if (folder.collapsed === undefined) folder.collapsed = false;

    const folderName = (folder.folderName || '').toLowerCase();
    const matchesFolder = folderName.includes(searchQuery);
    let filteredItems = folder.items || [];
    if (searchQuery) {
      if (!matchesFolder) {
        filteredItems = filteredItems.filter(item => 
          item.name.toLowerCase().includes(searchQuery) || 
          item.message.toLowerCase().includes(searchQuery)
        );
      }
      if (!matchesFolder && filteredItems.length === 0) return;
    }

    const folderColor = folder.color || '#2196f3';
    const textColor = getContrastYIQ(folderColor);
    const folderDiv = document.createElement('div');
    folderDiv.className = 'folder-div';
    
    if (folder.collapsed && !searchQuery) {
        folderDiv.classList.add('collapsed');
    }
    
    // Drag Attributes for Folder
    folderDiv.draggable = true;
    folderDiv.ondragstart = (e) => {
        e.stopPropagation();
        dragType = 'folder';
        dragSrcFolderIndex = fIndex;
        e.dataTransfer.effectAllowed = 'move';
        folderDiv.classList.add('dragging');
    };
    folderDiv.ondragover = (e) => {
        if(dragType === 'folder') {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            folderDiv.classList.add('drag-over');
        }
    };
    folderDiv.ondragleave = () => {
        folderDiv.classList.remove('drag-over');
    };
    folderDiv.ondrop = (e) => {
        if(dragType === 'folder') {
            e.stopPropagation();
            folderDiv.classList.remove('drag-over');
            folderDiv.classList.remove('dragging');
            if(dragSrcFolderIndex !== fIndex) {
                const item = buttonFolders.splice(dragSrcFolderIndex, 1)[0];
                buttonFolders.splice(fIndex, 0, item);
                saveButtonFolders();
            }
        }
    };
    folderDiv.ondragend = () => folderDiv.classList.remove('dragging');

    const header = document.createElement('div');
    header.className = 'folder-header';
    header.style.backgroundColor = folderColor;
    header.style.color = textColor;
    header.innerHTML = `
      <div style="display:flex; align-items:center;">
        <span class="material-symbols-outlined drag-handle" title="Drag to reorder">drag_indicator</span>
        <div class="title-area">
            <span class="material-symbols-outlined">folder</span>
            <span>${escapeHtml(folder.folderName || 'Untitled')}</span>
        </div>
      </div>
      <div class="controls">
        <button onclick="event.stopPropagation(); openButtonModal('${folder.id}', null)" title="Add Button" style="color:${textColor}; border-color:${textColor}">
          <span class="material-symbols-outlined" style="font-size:16px;">add</span>
        </button>
        <button onclick="event.stopPropagation(); openFolderModal('${folder.id}')" title="Folder Settings" style="color:${textColor}; border-color:${textColor}">
          <span class="material-symbols-outlined" style="font-size:16px;">settings</span>
        </button>
      </div>
    `;
    
    // Toggle Logic with Persistence
    header.onclick = (e) => {
        if(!e.target.closest('.drag-handle') && !e.target.closest('button')) {
            folderDiv.classList.toggle('collapsed');
            folder.collapsed = folderDiv.classList.contains('collapsed');
            saveButtonFolders();
        }
    };

    const list = document.createElement('div');
    list.className = 'buttons-list';
    
    // Allow dropping buttons into empty space or list
    list.ondragover = (e) => {
        if(dragType === 'button') {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            list.classList.add('drag-over');
        }
    };
    list.ondragleave = () => list.classList.remove('drag-over');
    list.ondrop = (e) => {
        if(dragType === 'button') {
            e.stopPropagation();
            list.classList.remove('drag-over');
            // If dropping on list background (not a specific button), append to end
            const srcFolder = buttonFolders[dragSrcFolderIndex];
            const btnItem = srcFolder.items.splice(dragSrcButtonIndex, 1)[0];
            folder.items.push(btnItem);
            saveButtonFolders();
        }
    };

    if (filteredItems && Array.isArray(filteredItems)) {
      filteredItems.forEach((item, originalIndex) => {
        const realIdx = folder.items.indexOf(item);
        const btn = document.createElement('button');
        const btnColor = item.color || '#2196F3';
        const btnTextCol = getContrastYIQ(btnColor);
        let previewText = replaceTags(item.message);
        if(previewText.length > 300) previewText = previewText.substring(0, 300) + '...';
        
        btn.className = 'copy-box';
        btn.style.backgroundColor = btnColor;
        btn.style.color = btnTextCol;
        btn.innerHTML = `${escapeHtml(item.name)}<span class="tooltip">${escapeHtml(previewText)}</span>`;
        btn.onclick = () => copyToClipboard(item.message);
        btn.oncontextmenu = (e) => {
          e.preventDefault();
          openButtonModal(folder.id, realIdx);
        };
        
        // Button Drag Attributes
        btn.draggable = true;
        btn.ondragstart = (e) => {
            e.stopPropagation();
            dragType = 'button';
            dragSrcFolderIndex = fIndex;
            dragSrcButtonIndex = realIdx;
            e.dataTransfer.effectAllowed = 'move';
            btn.classList.add('dragging');
        };
        btn.ondragover = (e) => {
            if(dragType === 'button') {
                e.preventDefault(); 
            }
        };
        btn.ondragend = () => btn.classList.remove('dragging');
        btn.ondrop = (e) => {
            if(dragType === 'button') {
                e.stopPropagation();
                const srcFolder = buttonFolders[dragSrcFolderIndex];
                const btnItem = srcFolder.items.splice(dragSrcButtonIndex, 1)[0];
                let targetIdx = realIdx;
                folder.items.splice(targetIdx, 0, btnItem);
                saveButtonFolders();
            }
        };

        list.appendChild(btn);
      });
    }

    folderDiv.appendChild(header);
    folderDiv.appendChild(list);
    container.appendChild(folderDiv);
  });
}

function saveButtonFolders() {
  localStorage.setItem('foldersV2', JSON.stringify(buttonFolders));
  renderButtonFolders();
}

/**
 * --- PART 5: MODAL LOGIC (Folders & Buttons) ---
 */
function openFolderModal(id) {
  editingFolderId = id;
  const modal = document.getElementById('folder-modal');
  const deleteBtn = document.getElementById('folder-delete-btn');
  if(id) {
    const folder = buttonFolders.find(f => f.id === id);
    document.getElementById('folder-modal-title').innerText = "Edit Folder";
    document.getElementById('folder-name-input').value = folder.folderName;
    document.getElementById('folder-color-input').value = folder.color || '#2196f3';
    deleteBtn.style.display = 'block';
  } else {
    document.getElementById('folder-modal-title').innerText = "New Folder";
    document.getElementById('folder-name-input').value = "";
    document.getElementById('folder-color-input').value = "#2196f3";
    deleteBtn.style.display = 'none';
  }
  modal.style.display = 'flex';
  document.getElementById('folder-name-input').focus();
}
function closeFolderModal() {
  document.getElementById('folder-modal').style.display = 'none';
  editingFolderId = null;
}
function saveFolder() {
  const name = document.getElementById('folder-name-input').value.trim();
  const color = document.getElementById('folder-color-input').value;
  if(!name) return alert("Please enter a folder name.");
  if(editingFolderId) {
    const folder = buttonFolders.find(f => f.id === editingFolderId);
    if(folder) {
      folder.folderName = name;
      folder.color = color;
    }
  } else {
    buttonFolders.push({ id: Date.now().toString(), folderName: name, color: color, items: [] });
  }
  saveButtonFolders();
  closeFolderModal();
}
function deleteFolderHelper() {
  if(!editingFolderId) return;
  if(confirm("Delete this folder and all its buttons?")) {
    buttonFolders = buttonFolders.filter(f => f.id !== editingFolderId);
    saveButtonFolders();
    closeFolderModal();
  }
}

function openButtonModal(folderId, btnIdx) {
  targetFolderId = folderId;
  editingBtnIndex = btnIdx; 
  const modal = document.getElementById('btn-modal');
  const deleteBtn = document.getElementById('btn-delete-btn');
  const folder = buttonFolders.find(f => f.id === folderId);
  if (!folder) return;

  const tagSelect = document.getElementById('tag-inserter');
  tagSelect.innerHTML = '<option value="">+ Insert Tag</option>';
  tagSelect.innerHTML += '<option value="[Date]">[Date]</option>';
  tagSelect.innerHTML += '<option value="[Time]">[Time]</option>';
  customTags.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.name;
      opt.text = t.name;
      tagSelect.appendChild(opt);
  });

  if (btnIdx !== null) {
    const item = folder.items[btnIdx];
    document.getElementById('btn-modal-title').innerText = "Edit Button";
    document.getElementById('btn-label-input').value = item.name;
    document.getElementById('btn-content-input').value = item.message;
    document.getElementById('btn-color-input').value = item.color || '#2196f3';
    deleteBtn.style.display = 'block';
  } else {
    document.getElementById('btn-modal-title').innerText = "New Button";
    document.getElementById('btn-label-input').value = '';
    document.getElementById('btn-content-input').value = '';
    document.getElementById('btn-color-input').value = folder.color || '#2196f3';
    deleteBtn.style.display = 'none';
  }
  modal.style.display = 'flex';
  document.getElementById('btn-label-input').focus();
}
function insertTagIntoMessage(select) {
    if(!select.value) return;
    const textarea = document.getElementById('btn-content-input');
    const startPos = textarea.selectionStart;
    const endPos = textarea.selectionEnd;
    textarea.value = textarea.value.substring(0, startPos) + select.value + textarea.value.substring(endPos, textarea.value.length);
    select.value = "";
    textarea.focus();
}
function closeBtnModal() {
  document.getElementById('btn-modal').style.display = 'none';
  targetFolderId = null;
  editingBtnIndex = null;
}
function saveButton() {
  const label = document.getElementById('btn-label-input').value.trim();
  const message = document.getElementById('btn-content-input').value.trim();
  const color = document.getElementById('btn-color-input').value;
  if(!label || !message) return alert("Please fill in label and content.");
  const folder = buttonFolders.find(f => f.id === targetFolderId);
  if(folder) {
    if(!folder.items) folder.items = [];
    if(editingBtnIndex !== null) {
      folder.items[editingBtnIndex] = { name: label, message: message, color: color };
    } else {
      folder.items.push({ name: label, message: message, color: color });
    }
    saveButtonFolders();
    closeBtnModal();
  }
}
function deleteButtonHelper() {
  if(targetFolderId === null || editingBtnIndex === null) return;
  const folder = buttonFolders.find(f => f.id === targetFolderId);
  if(folder && confirm("Delete this button?")) {
    folder.items.splice(editingBtnIndex, 1);
    saveButtonFolders();
    closeBtnModal();
  }
}

function copyToClipboard(text) {
  const finalUrl = replaceTags(text);
  navigator.clipboard.writeText(finalUrl).then(() => {
    const toast = document.createElement('div');
    toast.textContent = "Copied: " + finalUrl;
    toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:4px; z-index:2000; font-size:14px; max-width:80%; text-align:center;";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
  });
}

/**
 * --- PART 6: SIMPLIST RECURSIVE TASKS ---
 */

function getTaskByPath(cardIndex, path) {
    let task = cards[cardIndex].tasks[path[0]];
    for (let i = 1; i < path.length; i++) {
        task = task.subtasks[path[i]];
    }
    return task;
}

function calculateProgress(task) {
    let total = 0;
    let score = 0;
    function traverse(node) {
        if (node.subtasks && node.subtasks.length > 0) {
            node.subtasks.forEach(t => traverse(t));
        }
        total++;
        if(node.status === 'done') score += 1;
        else if(node.status === 'doing') score += 0.5;
    }
    if(task.subtasks) task.subtasks.forEach(t => traverse(t));
    return total === 0 ? 0 : (score/total)*100;
}

function calculateCardProgress(card) {
    let total = 0;
    let score = 0;
    function traverse(node) {
        total++;
        if(node.status === 'done') score += 1;
        else if(node.status === 'doing') score += 0.5;
        if(node.subtasks) node.subtasks.forEach(traverse);
    }
    card.tasks.forEach(traverse);
    return total === 0 ? 0 : (score/total)*100;
}

function getStatusIcon(status) {
    if(status === 'done') return 'check_circle';
    if(status === 'doing') return 'timelapse';
    return 'radio_button_unchecked';
}

function cycleTaskStatus(cardIndex, pathStr) {
    const path = pathStr.split(',').map(Number);
    const task = getTaskByPath(cardIndex, path);
    
    if(!task.status || task.status === 'todo') task.status = 'doing';
    else if(task.status === 'doing') task.status = 'done';
    else task.status = 'todo';
    
    task.done = (task.status === 'done'); // Sync legacy
    localStorage.setItem('simplist-data', JSON.stringify(cards));
    renderCards();
}

function moveTask(srcCardIdx, srcPath, destCardIdx, destPath, position) {
    // 1. CRITICAL CHECK: Prevent drop on self
    if (srcCardIdx === destCardIdx) {
        // Child check
        const isChild = srcPath.every((val, i) => destPath[i] === val);
        if (isChild && destPath.length > srcPath.length) return;
        
        // Exact same location (Self-Drop) - ABORT IMMEDIATELY to prevent deletion
        if (JSON.stringify(srcPath) === JSON.stringify(destPath) && position === 'inside') return;
        
        // Same list sibling check - if index is same or next (visual same), abort
        if (position !== 'inside' && srcPath.length === destPath.length) {
             const parentSrc = srcPath.slice(0, -1);
             const parentDest = destPath.slice(0, -1);
             if (JSON.stringify(parentSrc) === JSON.stringify(parentDest)) {
                 const srcI = srcPath[srcPath.length-1];
                 const destI = destPath[destPath.length-1];
                 if (srcI === destI) return;
                 if (position === 'after' && srcI === destI) return;
                 if (position === 'before' && srcI === destI) return;
             }
        }
    }

    // 2. Get Source Task
    const markTask = getTaskByPath(srcCardIdx, srcPath);
    markTask._toBeDeleted = true;
    
    // 3. Clone (Deep Copy)
    const taskClone = JSON.parse(JSON.stringify(markTask));
    delete taskClone._toBeDeleted; // Clean the clone
    
    // 4. Insert Clone
    if (position === 'inside') {
        const target = getTaskByPath(destCardIdx, destPath);
        if(!target.subtasks) target.subtasks = [];
        target.subtasks.push(taskClone);
        target.collapsed = false; 
    } else if (position === 'inside-card') {
        cards[destCardIdx].tasks.push(taskClone);
    } else {
        let targetList;
        let insertIdx;
        
        if (destPath.length === 1) {
            targetList = cards[destCardIdx].tasks;
            insertIdx = destPath[0];
        } else {
            const parentPath = destPath.slice(0, -1);
            const parent = getTaskByPath(destCardIdx, parentPath);
            targetList = parent.subtasks;
            insertIdx = destPath[destPath.length - 1];
        }
        
        if (position === 'after') insertIdx++;
        targetList.splice(insertIdx, 0, taskClone);
    }
    
    // 5. Sweep (Remove Original)
    function sweep(taskList) {
        for(let i = taskList.length - 1; i >= 0; i--) {
            if(taskList[i]._toBeDeleted) {
                taskList.splice(i, 1);
                return true; 
            }
            if(taskList[i].subtasks && sweep(taskList[i].subtasks)) return true;
        }
        return false;
    }
    sweep(cards[srcCardIdx].tasks);
    
    localStorage.setItem('simplist-data', JSON.stringify(cards));
    renderCards();
}

function renderCards() {
  const container = document.getElementById('card-list');
  const taskSearchQuery = document.getElementById('task-search').value.toLowerCase();
  container.innerHTML = '';
  
  cards.forEach((card, cardIndex) => {
    // Migration: If legacy 'done' exists but no status, convert
    if(card.tasks) {
        const migrate = (list) => {
            list.forEach(t => {
                if(!t.status) t.status = t.done ? 'done' : 'todo';
                if(t.subtasks) migrate(t.subtasks);
            });
        };
        migrate(card.tasks);
    }

    const cardDiv = document.createElement('div');
    cardDiv.className = 'card-mat';
    
    // Card Drop Logic
    cardDiv.ondragover = (e) => {
        if(dragType === 'card') { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        if(dragType === 'task') { e.preventDefault(); } 
    };
    cardDiv.ondrop = (e) => {
        e.stopPropagation();
        if(dragType === 'card' && dragSrcCardIndex !== cardIndex) {
            const item = cards.splice(dragSrcCardIndex, 1)[0];
            cards.splice(cardIndex, 0, item);
            localStorage.setItem('simplist-data', JSON.stringify(cards));
            renderCards();
        }
        if(dragType === 'task') {
             if (!e.target.closest('.task-node')) {
                 moveTask(dragSrcCardIndex, dragSrcTaskPath, cardIndex, [], 'inside-card');
             }
        }
    };
    
    // Persist collapsed state
    if(card.collapsed && !taskSearchQuery) cardDiv.classList.add('collapsed');

    const headerColor = card.color || '#f3edff';
    const textColor = getContrastYIQ(headerColor);
    const pct = calculateCardProgress(card);
    
    const header = document.createElement('div');
    header.className = 'card-header';
    header.style.backgroundColor = headerColor;
    header.style.color = textColor;
    
    header.innerHTML = `
      <div style="flex:1;">
        <div style="display:flex; align-items:center;">
            <span class="material-symbols-outlined drag-handle card-drag-handle" draggable="true" title="Drag to reorder">drag_indicator</span>
            <div class="title-area">
                <span style="font-size:1.1em; font-weight:600;">${escapeHtml(card.title)}</span>
            </div>
        </div>
        <div class="progress-track" style="display:${card.tasks.length>0?'block':'none'}">
            <div class="progress-fill" style="width:${pct}%"></div>
        </div>
      </div>
      <div class="controls">
         <button onclick="event.stopPropagation(); openListModal('${card.id}')" title="List Settings" style="color:${textColor}; border-color:${textColor}">
            <span class="material-symbols-outlined" style="font-size:16px;">settings</span>
         </button>
      </div>
    `;
    
    // LIST DRAG HANDLER
    const listGrip = header.querySelector('.card-drag-handle');
    listGrip.ondragstart = (e) => {
        e.stopPropagation();
        dragSrcCardIndex = cardIndex;
        dragType = 'card';
        e.dataTransfer.effectAllowed = 'move';
        cardDiv.classList.add('dragging');
    };
    listGrip.ondragend = () => {
        cardDiv.classList.remove('dragging');
    };
    
    header.onclick = (e) => {
        if(!e.target.closest('.drag-handle') && !e.target.closest('button')) {
            cardDiv.classList.toggle('collapsed');
            card.collapsed = cardDiv.classList.contains('collapsed');
            localStorage.setItem('simplist-data', JSON.stringify(cards));
        }
    };
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'card-content';
    const ul = document.createElement('div');
    ul.className = 'task-list';
    
    function renderTaskTree(tasks, path) {
        const wrapper = document.createElement('div');
        tasks.forEach((task, idx) => {
            const matchesSearch = taskSearchQuery ? JSON.stringify(task).toLowerCase().includes(taskSearchQuery) : true;
            if(!matchesSearch) return;

            const currentPath = [...path, idx];
            const pathStr = currentPath.join(',');
            
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'task-node';
            
            // Task Drop Logic
            nodeDiv.ondragover = (e) => {
                if(dragType !== 'task') return;
                
                // PREVENT SELF DROP HIGHLIGHTS
                if (dragSrcCardIndex === cardIndex && JSON.stringify(dragSrcTaskPath) === JSON.stringify(currentPath)) {
                    return; 
                }

                e.preventDefault();
                e.stopPropagation();
                
                const rect = nodeDiv.getBoundingClientRect();
                const y = e.clientY - rect.top;
                
                nodeDiv.classList.remove('drop-above', 'drop-below', 'drop-inside');
                if (y < rect.height * 0.25) nodeDiv.classList.add('drop-above');
                else if (y > rect.height * 0.75) nodeDiv.classList.add('drop-below');
                else nodeDiv.classList.add('drop-inside');
            };
            
            nodeDiv.ondragleave = (e) => {
                if(nodeDiv.contains(e.relatedTarget)) return;
                nodeDiv.classList.remove('drop-above', 'drop-below', 'drop-inside');
            };
            
            nodeDiv.ondrop = (e) => {
                if(dragType !== 'task') return;
                e.stopPropagation();
                
                let position = 'inside';
                if (nodeDiv.classList.contains('drop-above')) position = 'before';
                else if (nodeDiv.classList.contains('drop-below')) position = 'after';
                
                nodeDiv.classList.remove('drop-above', 'drop-below', 'drop-inside');
                moveTask(dragSrcCardIndex, dragSrcTaskPath, cardIndex, currentPath, position);
            };
            
            const nodePct = calculateProgress(task);
            
            const row = document.createElement('div');
            row.className = 'task-row';
            
            const taskHandle = document.createElement('span');
            taskHandle.className = 'material-symbols-outlined task-drag-handle';
            taskHandle.innerText = 'drag_indicator';
            taskHandle.draggable = true;
            
            taskHandle.ondragstart = (e) => {
                e.stopPropagation();
                dragType = 'task';
                dragSrcCardIndex = cardIndex;
                dragSrcTaskPath = currentPath;
                e.dataTransfer.effectAllowed = 'move';
                nodeDiv.classList.add('dragging-task');
            };
            taskHandle.ondragend = () => {
                nodeDiv.classList.remove('dragging-task');
                document.querySelectorAll('.task-node').forEach(el => el.classList.remove('drop-above', 'drop-below', 'drop-inside'));
            };

            const chevron = document.createElement('span');
            chevron.className = 'material-symbols-outlined collapse-icon';
            if (task.subtasks && task.subtasks.length > 0) {
                const isExpanded = taskSearchQuery ? true : !task.collapsed;
                chevron.innerText = isExpanded ? 'expand_more' : 'chevron_right';
                chevron.onclick = () => toggleTaskCollapse(cardIndex, pathStr);
            } else {
                chevron.className += ' collapse-placeholder';
            }

            // STATUS ICON (Tri-State)
            const statusIcon = document.createElement('span');
            statusIcon.className = 'material-symbols-outlined task-status-icon status-' + (task.status || 'todo');
            statusIcon.innerText = getStatusIcon(task.status);
            statusIcon.onclick = () => cycleTaskStatus(cardIndex, pathStr);
            
            const span = document.createElement('span');
            span.className = 'task-text ' + (task.status==='done' ? 'task-done' : '');
            span.contentEditable = true;
            span.textContent = task.text;
            span.onblur = (e) => updateTaskText(cardIndex, pathStr, e.target.innerText);
            
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            const dStatus = getDateStatus(task.due);
            dateInput.className = 'date-input ' + (task.status!=='done' ? dStatus : '');
            dateInput.value = task.due || '';
            dateInput.onchange = (e) => updateTaskDate(cardIndex, pathStr, e.target.value);
            
            const addSubBtn = document.createElement('span');
            addSubBtn.className = 'material-symbols-outlined action-btn';
            addSubBtn.innerText = 'playlist_add';
            addSubBtn.title = "Add Subtask";
            addSubBtn.onclick = () => addSubtask(cardIndex, pathStr);

            const delBtn = document.createElement('span');
            delBtn.className = 'material-symbols-outlined action-btn delete';
            delBtn.innerText = 'delete';
            delBtn.onclick = () => deleteTask(cardIndex, pathStr);
            
            row.appendChild(taskHandle); 
            row.appendChild(chevron);
            row.appendChild(statusIcon);
            row.appendChild(span);
            if(task.subtasks && task.subtasks.length > 0 && nodePct < 100) {
                 const barTrack = document.createElement('div');
                 barTrack.className = 'node-progress-track';
                 const barFill = document.createElement('div');
                 barFill.className = 'node-progress-fill';
                 barFill.style.width = nodePct + '%';
                 barTrack.appendChild(barFill);
                 row.appendChild(barTrack);
            }
            row.appendChild(dateInput);
            row.appendChild(addSubBtn);
            row.appendChild(delBtn);
            nodeDiv.appendChild(row);
            
            if(task.subtasks && task.subtasks.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'task-children';
                if(task.collapsed && !taskSearchQuery) childrenDiv.classList.add('hidden');
                childrenDiv.appendChild(renderTaskTree(task.subtasks, currentPath));
                nodeDiv.appendChild(childrenDiv);
            }
            wrapper.appendChild(nodeDiv);
        });
        return wrapper;
    }

    ul.appendChild(renderTaskTree(card.tasks, []));
    
    const addRow = document.createElement('div');
    addRow.className = 'add-task-row';
    let tplOptions = '';
    taskTemplates.forEach(tpl => {
        tplOptions += `<div class="mini-menu-item" onclick="insertTemplateTask(${cardIndex}, '${tpl.id}')">${escapeHtml(tpl.name)}</div>`;
    });
    const menuId = `tpl-menu-${cardIndex}`;
    addRow.innerHTML = `
      <input type="text" id="add-input-${cardIndex}" class="add-task-input" placeholder="+ Add a task" onkeydown="if(event.key==='Enter') addTask(${cardIndex}, this)">
      <div style="position:relative;">
          <button class="template-picker-btn" title="Add from Template" onclick="document.getElementById('${menuId}').style.display = document.getElementById('${menuId}').style.display === 'block' ? 'none' : 'block'">
             <span class="material-symbols-outlined">post_add</span>
          </button>
          <div id="${menuId}" class="mini-menu">
             <div class="mini-menu-item" style="color:#888; border-bottom:1px solid #eee; cursor:default;">Select Template...</div>
             ${tplOptions.length ? tplOptions : '<div style="padding:10px; color:#999; font-style:italic;">No templates</div>'}
             <div class="mini-menu-item" style="border-top:1px solid #eee; color:#2196f3;" onclick="openTemplateManager()">+ Manage Templates</div>
          </div>
      </div>
    `;

    contentDiv.appendChild(ul);
    contentDiv.appendChild(addRow);
    cardDiv.appendChild(header);
    cardDiv.appendChild(contentDiv);
    container.appendChild(cardDiv);
  });
  
  window.onclick = function(e) {
      if(!e.target.closest('.template-picker-btn')) {
          document.querySelectorAll('.mini-menu').forEach(el => el.style.display = 'none');
      }
  };
  localStorage.setItem('simplist-data', JSON.stringify(cards));
}

// --- List Modal ---
function openListModal(id) {
    editingListId = id;
    const modal = document.getElementById('list-modal');
    const deleteBtn = document.getElementById('list-delete-btn');
    if(id) {
        const card = cards.find(c => c.id === id);
        document.getElementById('list-modal-title').innerText = "List Settings";
        document.getElementById('list-name-input').value = card.title;
        document.getElementById('list-color-input').value = card.color || '#673ab7';
        deleteBtn.style.display = 'block';
    } else {
        document.getElementById('list-modal-title').innerText = "New List";
        document.getElementById('list-name-input').value = "";
        document.getElementById('list-color-input').value = "#673ab7";
        deleteBtn.style.display = 'none';
    }
    modal.style.display = 'flex';
    document.getElementById('list-name-input').focus();
}
function closeListModal() {
    document.getElementById('list-modal').style.display = 'none';
    editingListId = null;
}
function saveList() {
    const name = document.getElementById('list-name-input').value.trim();
    const color = document.getElementById('list-color-input').value;
    if(!name) return alert("Please enter a list name.");
    if(editingListId) {
        const card = cards.find(c => c.id === editingListId);
        if(card) {
            card.title = name;
            card.color = color;
        }
    } else {
        cards.push({ id: Date.now().toString(), title: name, color: color, tasks: [] });
    }
    renderCards();
    closeListModal();
}
function deleteListHelper() {
    if(!editingListId) return;
    if(confirm("Delete this entire list?")) {
        cards = cards.filter(c => c.id !== editingListId);
        renderCards();
        closeListModal();
    }
}

// --- Task Functions ---
function addTask(cardIndex, input) {
  if(!input.value.trim()) return;
  cards[cardIndex].tasks.push({ text: input.value, status:'todo', done: false, due:'', subtasks: [], collapsed: false });
  input.value = '';
  renderCards();
  setTimeout(() => {
    const inputs = document.querySelectorAll('.add-task-input');
    if(inputs[cardIndex]) inputs[cardIndex].focus();
  }, 50);
}

function cloneTask(task) {
    return {
        text: task.text,
        status: 'todo',
        done: false,
        due: '',
        collapsed: false,
        subtasks: task.subtasks ? task.subtasks.map(cloneTask) : []
    };
}

function insertTemplateTask(cardIndex, tplId) {
    const tpl = taskTemplates.find(t => t.id === tplId);
    if (!tpl) return;
    const input = document.getElementById(`add-input-${cardIndex}`);
    const taskName = input.value.trim() || tpl.name;
    const newTask = {
        text: taskName,
        status: 'todo',
        done: false,
        due: '',
        collapsed: false,
        subtasks: tpl.subtasks ? tpl.subtasks.map(cloneTask) : []
    };
    cards[cardIndex].tasks.push(newTask);
    input.value = ''; 
    renderCards();
}

function toggleTask(cardIndex, pathStr) {
    // Legacy checkbox handler if any
    cycleTaskStatus(cardIndex, pathStr);
}
function updateTaskText(cardIndex, pathStr, val) {
    const path = pathStr.split(',').map(Number);
    const task = getTaskByPath(cardIndex, path);
    task.text = val;
    localStorage.setItem('simplist-data', JSON.stringify(cards));
}
function updateTaskDate(cardIndex, pathStr, val) {
    const path = pathStr.split(',').map(Number);
    const task = getTaskByPath(cardIndex, path);
    task.due = val;
    renderCards(); 
}
function toggleTaskCollapse(cardIndex, pathStr) {
    const path = pathStr.split(',').map(Number);
    const task = getTaskByPath(cardIndex, path);
    task.collapsed = !task.collapsed;
    localStorage.setItem('simplist-data', JSON.stringify(cards)); // Save state
    renderCards();
}
function addSubtask(cardIndex, pathStr) {
    const path = pathStr.split(',').map(Number);
    const task = getTaskByPath(cardIndex, path);
    if(!task.subtasks) task.subtasks = [];
    task.subtasks.push({ text: "New Step", status:'todo', done: false, due: '', collapsed: false, subtasks: [] });
    task.collapsed = false; 
    renderCards();
}
function deleteTask(cardIndex, pathStr) {
    const path = pathStr.split(',').map(Number);
    const idx = path.pop();
    if(path.length === 0) {
        cards[cardIndex].tasks.splice(idx, 1);
    } else {
        const parent = getTaskByPath(cardIndex, path);
        parent.subtasks.splice(idx, 1);
    }
    renderCards();
}

/**
 * --- PART 7: IMPORT / EXPORT ---
 */
function exportData() {
  const data = {
    folders: buttonFolders,
    customTags: customTags,
    cards: cards,
    templates: taskTemplates
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'simplist_complete_backup.json';
  a.click();
}

document.getElementById('file-upload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if(data.folders) buttonFolders = data.folders;
      if(data.cards) cards = data.cards;
      if(data.customTags) customTags = data.customTags;
      if(data.templates) taskTemplates = data.templates;
      
      saveButtonFolders();
      localStorage.setItem('customTags', JSON.stringify(customTags));
      localStorage.setItem('simplist-templates', JSON.stringify(taskTemplates));
      renderCards();
      alert('Import successful!');
    } catch(err) {
      alert('Error parsing file.');
    }
  };
  reader.readAsText(file);
});

// Init
renderButtonFolders();
renderCards();

</script>
</body>
</html>